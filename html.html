<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Platform AR - å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      background: #000;
    }
    
    .platform-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    
    /* A-Frameç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .aframe-container {
      width: 100%;
      height: 100%;
    }
    
    /* model-viewerç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .model-viewer-container {
      width: 100%;
      height: 100%;
      display: none;
    }
    
    model-viewer {
      width: 100%;
      height: 100%;
      background-color: transparent;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      color: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 320px;
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #00d4ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-panel p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 8px;
      color: #e0e0e0;
    }
    
    .platform-info {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .ar-status {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .ar-status.active {
      background: rgba(107, 207, 127, 0.2);
      border-color: rgba(107, 207, 127, 0.5);
    }
    
    .ar-status.error {
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.3);
    }
    
    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
    .debug-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 15px;
      border-radius: 12px;
      max-width: 380px;
      max-height: 60vh;
      overflow-y: auto;
      pointer-events: auto;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .debug-panel h3 {
      color: #ff6b6b;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .debug-log {
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #4ecdc4;
      font-size: 11px;
    }
    
    .debug-error {
      border-left-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }
    
    .debug-warning {
      border-left-color: #ffd93d;
      background: rgba(255, 217, 61, 0.1);
    }
    
    .debug-success {
      border-left-color: #6bcf7f;
      background: rgba(107, 207, 127, 0.1);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .status-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 11px;
    }
    
    .status-ok {
      background: rgba(107, 207, 127, 0.2);
    }
    
    .status-error {
      background: rgba(255, 107, 107, 0.2);
    }
    
    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      pointer-events: auto;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      padding: 15px 25px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn.ar-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: white;
    }
    
    .btn.ar-active {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 6px 20px rgba(0,212,255,0.4); }
      50% { box-shadow: 0 6px 30px rgba(0,212,255,0.8); }
    }
    
    .ar-instructions {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 14px;
      text-align: center;
      max-width: 300px;
      pointer-events: auto;
      display: none;
    }
    
    .ar-instructions.show {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 15px;
      font-size: 18px;
      z-index: 2000;
      display: none;
      text-align: center;
    }
    
    .loading.show {
      display: block;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* iOSå°‚ç”¨ã®AR Quick Lookç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .ios-ar-link {
      display: none;
    }

    .model-scale-controls {
      position: absolute;
      bottom: 150px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 12px;
      pointer-events: auto;
      display: none;
    }

    .model-scale-controls.show {
      display: block;
    }

    .scale-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .scale-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ‘ãƒãƒ« */
    .object-manager {
      position: absolute;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      max-width: 280px;
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .object-manager h4 {
      color: #00d4ff;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .object-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .object-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .object-item.selected {
      background: rgba(0, 212, 255, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.6);
    }

    .object-priority {
      background: #ff6b6b;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      margin-left: 8px;
    }

    .object-priority.high {
      background: #ff6b6b;
    }

    .object-priority.medium {
      background: #ffd93d;
      color: #333;
    }

    .object-priority.low {
      background: #6bcf7f;
    }

    /* ã‚¿ãƒƒãƒæƒ…å ±ãƒ‘ãƒãƒ« */
    .touch-info-panel {
      position: absolute;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      color: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 320px;
      text-align: center;
      pointer-events: auto;
      border: 2px solid rgba(0, 212, 255, 0.5);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .touch-info-panel h4 {
      color: #00d4ff;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .touch-info-panel p {
      margin-bottom: 15px;
      font-size: 13px;
      color: #e0e0e0;
    }

    .touch-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .touch-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .touch-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .object-highlight {
      animation: highlight-pulse 2s infinite;
    }

    @keyframes highlight-pulse {
      0%, 100% { 
        filter: drop-shadow(0 0 5px #00d4ff); 
      }
      50% { 
        filter: drop-shadow(0 0 20px #00d4ff) drop-shadow(0 0 30px #00d4ff); 
      }
    }

    .touch-ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(0, 212, 255, 0.6);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }

    @keyframes ripple {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(4);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="platform-container">
    
    <!-- A-Frame AR (Android/Desktopç”¨) -->
    <div class="aframe-container" id="aframe-container">
      <a-scene 
        id="scene"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        background="color: transparent"
        ar-hit-test
      >
        <!-- ç’°å¢ƒå…‰ -->
        <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="0 5 5"></a-entity>
        
        <!-- ARç©ºé–“ï¼ˆé…ç½®ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
        <a-entity id="ar-world" position="0 0 0">
          <!-- é…ç½®ã•ã‚ŒãŸå»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </a-entity>
        
        <!-- ã‚«ãƒ¡ãƒ©ï¼ˆãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ä»˜ãï¼‰ -->
        <a-entity 
          id="camera" 
          camera 
          look-controls 
          wasd-controls="enabled: false" 
          position="0 1.6 0"
          raycaster="objects: .interactive; far: 100; interval: 100"
          cursor="rayOrigin: mouse; fuse: false"
          ar-interaction-handler
        ></a-entity>
      </a-scene>
    </div>

    <!-- model-viewer (iOSç”¨) -->
    <div class="model-viewer-container" id="model-viewer-container">
      <model-viewer
        id="warehouse-viewer"
        src="./models/abandoned_warehouse_-_interior_scene.glb"
        ar
        ar-modes="webxr scene-viewer quick-look"
        camera-controls
        shadow-intensity="1"
        auto-rotate
        auto-rotate-delay="3000"
        environment-image="neutral"
        poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23222'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='0.35em' fill='white' font-family='Arial' font-size='12'%3Eå»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«%3C/text%3E%3C/svg%3E"
      >
        <button id="ar-button" slot="ar-button" class="btn ar-btn">
          <span>ğŸ—ï¸</span>
          <span>ARã§é…ç½®</span>
        </button>
      </model-viewer>
    </div>

  </div>

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI -->
  <div class="overlay">
    <div class="info-panel">
      <h2>ğŸ—ï¸ å»ƒå€‰åº« ARé…ç½®</h2>
      <p><strong>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :</strong> <span id="platform-info">æ¤œå‡ºä¸­...</span></p>
      <div id="ar-status-indicator" class="ar-status">
        <p style="margin: 0; font-size: 12px;" id="ar-status-text">åˆæœŸåŒ–ä¸­...</p>
      </div>
      <div id="platform-specific-info" class="platform-info">
        <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®æƒ…å ±ãŒã“ã“ã«è¡¨ç¤º -->
      </div>
    </div>
    
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel">
      <h3>ğŸ” ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨ºæ–­</h3>
      
      <div class="status-grid">
        <div class="status-item" id="platform-status">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : æ¤œå‡ºä¸­</div>
        <div class="status-item" id="ar-support-status">ARã‚µãƒãƒ¼ãƒˆ: ç¢ºèªä¸­</div>
        <div class="status-item" id="camera-status">ã‚«ãƒ¡ãƒ©: æœªç¢ºèª</div>
        <div class="status-item" id="model-status">ãƒ¢ãƒ‡ãƒ«: èª­ã¿è¾¼ã¿ä¸­</div>
      </div>
      
      <div id="debug-logs" style="max-height: 150px; overflow-y: auto;">
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
    </div>
    
    <!-- ARä½¿ç”¨èª¬æ˜ -->
    <div class="ar-instructions" id="ar-instructions">
      <p id="instruction-text">åºŠé¢ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¿ãƒƒãƒ—ã§é…ç½®</p>
    </div>

    <!-- ãƒ¢ãƒ‡ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ -->
    <div class="model-scale-controls" id="scale-controls">
      <h4 style="color: white; margin-bottom: 10px; font-size: 12px;">ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º</h4>
      <button class="scale-btn" onclick="changeScale(0.5)">å° (50%)</button>
      <button class="scale-btn" onclick="changeScale(1.0)">æ¨™æº– (100%)</button>
      <button class="scale-btn" onclick="changeScale(2.0)">å¤§ (200%)</button>
    </div>
    
    <!-- é…ç½®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ‘ãƒãƒ« -->
    <div class="object-manager" id="object-manager" style="display: none;">
      <h4>ğŸ¯ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ– ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</h4>
      <div id="object-list">
        <!-- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒã“ã“ã«è¡¨ç¤º -->
      </div>
    </div>

    <!-- ã‚¿ãƒƒãƒæƒ…å ±ãƒ‘ãƒãƒ« -->
    <div class="touch-info-panel" id="touch-info-panel" style="display: none;">
      <h4 id="touch-object-name">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå</h4>
      <p id="touch-object-desc">èª¬æ˜ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      <div class="touch-actions">
        <button class="touch-btn" onclick="highlightObject()">ğŸ”† ãƒã‚¤ãƒ©ã‚¤ãƒˆ</button>
        <button class="touch-btn" onclick="animateObject()">ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
        <button class="touch-btn" onclick="deleteSelectedObject()">ğŸ—‘ï¸ å‰Šé™¤</button>
      </div>
    </div>
    
    <div class="controls">
      <button class="btn ar-btn" id="start-ar-btn" onclick="startAR()">
        <span>ğŸ“±</span>
        <span id="ar-btn-text">ARé–‹å§‹</span>
      </button>
      <button class="btn" id="place-warehouse-btn" onclick="placeWarehouseModel()" disabled>
        <span>ğŸ—ï¸</span>
        <span>å»ƒå€‰åº«é…ç½®</span>
      </button>
      <button class="btn primary" id="place-interactive-btn" onclick="placeInteractiveObject()" disabled>
        <span>âš¡</span>
        <span>æ©Ÿæ¢°é…ç½®</span>
      </button>
      <button class="btn" onclick="clearModels()">
        <span>ğŸ—‘ï¸</span>
        <span>å…¨å‰Šé™¤</span>
      </button>
      <button class="btn primary" onclick="takeScreenshot()">
        <span>ğŸ“¸</span>
        <span>ã‚¹ã‚¯ã‚·ãƒ§</span>
      </button>
    </div>
  </div>
  
  <div class="loading show" id="loading">
    <div class="loading-spinner"></div>
    <div>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºä¸­...</div>
  </div>

  <!-- iOSç”¨AR Quick Look ãƒªãƒ³ã‚¯ (éè¡¨ç¤º) -->
  <a id="ios-ar-link" class="ios-ar-link" rel="ar" href="#">
    <img id="ios-ar-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" alt="AR View">
  </a>

  <!-- AR Hit Test Component for A-Frame -->
  <script>
    // AR Hit Test Component
    AFRAME.registerComponent('ar-hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.currentPose = null;
        this.isSessionActive = false;
        
        this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
        this.el.sceneEl.addEventListener('exit-vr', this.onExitVR.bind(this));
        
        this.debugLog('AR Hit Test ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–', 'info');
      },
      
      onEnterVR: function () {
        this.isSessionActive = true;
        const scene = this.el.sceneEl;
        const xrSession = scene.renderer.xr.getSession();
        
        if (xrSession) {
          this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
          this.setupHitTest(xrSession);
        }
      },
      
      onExitVR: function () {
        this.isSessionActive = false;
        this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†', 'info');
      },
      
      setupHitTest: async function (session) {
        try {
          this.viewerSpace = await session.requestReferenceSpace('viewer');
          const hitTestSource = await session.requestHitTestSource({
            space: this.viewerSpace
          });
          this.xrHitTestSource = hitTestSource;
          this.debugLog('Hit Test åˆæœŸåŒ–å®Œäº†', 'success');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', true);
        } catch (error) {
          this.debugLog(`Hit Test ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¨ãƒ©ãƒ¼', false);
        }
      },
      
      tick: function () {
        if (!this.isSessionActive || !this.xrHitTestSource) return;
        
        const frame = this.el.sceneEl.frame;
        if (!frame) return;
        
        const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
        
        if (hitTestResults.length > 0) {
          this.hitTestResults = hitTestResults;
          const hit = hitTestResults[0];
          const pose = hit.getPose(this.el.sceneEl.renderer.xr.getReferenceSpace());
          
          if (pose) {
            this.currentPose = pose;
            
            // é…ç½®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('place-warehouse-btn').disabled = false;
            document.getElementById('place-interactive-btn').disabled = false;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('ar-status-text').textContent = 'åºŠé¢æ¤œå‡º - ã‚¿ãƒƒãƒ—ã§é…ç½®';
            const indicator = document.getElementById('ar-status-indicator');
            indicator.classList.add('active');
            
            // èª¬æ˜è¡¨ç¤º
            const instructions = document.getElementById('ar-instructions');
            instructions.classList.add('show');
          }
        } else {
          document.getElementById('place-warehouse-btn').disabled = true;
          document.getElementById('place-interactive-btn').disabled = true;
          
          const instructions = document.getElementById('ar-instructions');
          instructions.classList.remove('show');
        }
      },
      
      getCurrentPose: function () {
        return this.currentPose;
      },
      
      debugLog: function (message, type = 'info') {
        if (window.debugLog) {
          window.debugLog(message, type);
        }
      }
    });

    // AR Interaction Handler Component
    AFRAME.registerComponent('ar-interaction-handler', {
      init: function () {
        this.selectedObject = null;
        this.interactiveObjects = new Map();
        
        // ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        this.el.addEventListener('raycaster-intersected', this.onIntersected.bind(this));
        this.el.addEventListener('raycaster-intersected-cleared', this.onIntersectedCleared.bind(this));
        
        // ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        this.el.addEventListener('click', this.onObjectClicked.bind(this));
        
        this.debugLog('AR Interaction Handler åˆæœŸåŒ–', 'info');
      },
      
      onIntersected: function (evt) {
        const intersectedEl = evt.detail.el;
        if (intersectedEl.classList.contains('interactive')) {
          this.highlightObject(intersectedEl, true);
        }
      },
      
      onIntersectedCleared: function (evt) {
        const intersectedEl = evt.detail.el;
        if (intersectedEl.classList.contains('interactive')) {
          this.highlightObject(intersectedEl, false);
        }
      },
      
      onObjectClicked: function (evt) {
        const intersections = this.el.components.raycaster.intersections;
        if (intersections.length === 0) return;
        
        // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆè·é›¢ãŒè¿‘ã„é † + å„ªå…ˆåº¦ï¼‰
        const sortedIntersections = intersections
          .filter(intersection => intersection.object.el.classList.contains('interactive'))
          .sort((a, b) => {
            const priorityA = parseInt(a.object.el.getAttribute('data-priority') || '0');
            const priorityB = parseInt(b.object.el.getAttribute('data-priority') || '0');
            
            // å„ªå…ˆåº¦ãŒé«˜ã„æ–¹ã‚’å„ªå…ˆã€åŒã˜å ´åˆã¯è·é›¢ãŒè¿‘ã„æ–¹
            if (priorityA !== priorityB) {
              return priorityB - priorityA; // é«˜ã„å„ªå…ˆåº¦ãŒå…ˆ
            }
            return a.distance - b.distance; // è¿‘ã„è·é›¢ãŒå…ˆ
          });
        
        if (sortedIntersections.length > 0) {
          const selectedEl = sortedIntersections[0].object.el;
          this.selectObject(selectedEl);
          this.showTouchRipple(evt.detail.intersection.point);
        }
      },
      
      selectObject: function (element) {
        this.selectedObject = element;
        const objectData = this.interactiveObjects.get(element.id);
        
        if (objectData) {
          this.debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ: ${objectData.name}`, 'info');
          this.showObjectInfo(objectData);
          this.updateObjectManager();
          
          // é¸æŠã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
          this.addSelectionEffect(element);
        }
      },
      
      highlightObject: function (element, highlight) {
        if (highlight) {
          element.classList.add('object-highlight');
        } else {
          element.classList.remove('object-highlight');
        }
      },
      
      addSelectionEffect: function (element) {
        // æ—¢å­˜ã®é¸æŠã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
        document.querySelectorAll('.interactive').forEach(el => {
          el.classList.remove('object-highlight');
        });
        
        // æ–°ã—ã„é¸æŠã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
        element.classList.add('object-highlight');
      },
      
      showTouchRipple: function (position) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = '50%';
        ripple.style.top = '50%';
        ripple.style.width = '20px';
        ripple.style.height = '20px';
        ripple.style.marginLeft = '-10px';
        ripple.style.marginTop = '-10px';
        
        document.body.appendChild(ripple);
        
        setTimeout(() => {
          document.body.removeChild(ripple);
        }, 600);
      },
      
      showObjectInfo: function (objectData) {
        const panel = document.getElementById('touch-info-panel');
        const nameEl = document.getElementById('touch-object-name');
        const descEl = document.getElementById('touch-object-desc');
        
        nameEl.textContent = objectData.name;
        descEl.textContent = objectData.description;
        
        panel.style.display = 'block';
        
        // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
        setTimeout(() => {
          panel.style.display = 'none';
        }, 3000);
      },
      
      updateObjectManager: function () {
        const container = document.getElementById('object-list');
        const manager = document.getElementById('object-manager');
        
        if (this.interactiveObjects.size > 0) {
          manager.style.display = 'block';
          
          container.innerHTML = Array.from(this.interactiveObjects.entries()).map(([id, data]) => {
            const isSelected = this.selectedObject && this.selectedObject.id === id;
            const priorityClass = data.priority >= 8 ? 'high' : data.priority >= 5 ? 'medium' : 'low';
            const priorityText = data.priority >= 8 ? 'HIGH' : data.priority >= 5 ? 'MED' : 'LOW';
            
            return `
              <div class="object-item ${isSelected ? 'selected' : ''}" onclick="window.selectObjectById('${id}')">
                <span>${data.name}</span>
                <span class="object-priority ${priorityClass}">${priorityText}</span>
              </div>
            `;
          }).join('');
        } else {
          manager.style.display = 'none';
        }
      },
      
      registerObject: function (element, objectData) {
        this.interactiveObjects.set(element.id, objectData);
        this.updateObjectManager();
      },
      
      unregisterObject: function (elementId) {
        this.interactiveObjects.delete(elementId);
        this.updateObjectManager();
      },
      
      debugLog: function (message, type = 'info') {
        if (window.debugLog) {
          window.debugLog(message, type);
        }
      }
    });
  </script>

  <script>
    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡º
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;
    
    // ãƒ‡ãƒãƒƒã‚°è¨­å®š
    let debugMode = true;
    const debugLogs = [];
    let placedModels = [];
    let currentModelScale = 1.0;
    let currentPlatform = 'unknown';
    let selectedObjectGlobal = null;
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—å®šç¾©ï¼ˆå„ªå…ˆåº¦ä»˜ãï¼‰
    const objectTypes = {
      warehouse: {
        name: 'å»ƒå€‰åº«',
        description: 'ãƒ€ãƒ¼ã‚¯ã§ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ãªå»ƒå€‰åº«ã€‚å†…éƒ¨ã«ã¯å¤ã„æ©Ÿæ¢°ãŒæ®‹ã•ã‚Œã¦ã„ã‚‹ã€‚',
        priority: 10,
        color: '#8B4513',
        interactive: true,
        sounds: ['ambient_industrial.mp3', 'wind_through_ruins.mp3']
      },
      machine: {
        name: 'å¤ã„æ©Ÿæ¢°',
        description: 'éŒ†ã³ä»˜ã„ãŸå·¥æ¥­ç”¨æ©Ÿæ¢°ã€‚ã¾ã å‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚',
        priority: 8,
        color: '#4A4A4A',
        interactive: true,
        sounds: ['machine_hum.mp3', 'gear_turning.mp3']
      },
      generator: {
        name: 'ç™ºé›»æ©Ÿ',
        description: 'å·¨å¤§ãªç™ºé›»æ©Ÿã€‚é›»æ°—ãŒæµã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚',
        priority: 7,
        color: '#FFD700',
        interactive: true,
        sounds: ['electric_hum.mp3', 'power_surge.mp3']
      },
      container: {
        name: 'ã‚³ãƒ³ãƒ†ãƒŠ',
        description: 'é‡‘å±è£½ã®ã‚³ãƒ³ãƒ†ãƒŠã€‚ä¸­ã«ä½•ã‹ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚',
        priority: 5,
        color: '#87CEEB',
        interactive: true,
        sounds: ['metal_clang.mp3', 'container_open.mp3']
      },
      debris: {
        name: 'ç“¦ç¤«',
        description: 'å´©ã‚ŒãŸå»ºæã‚„é‡‘å±ç‰‡ã€‚æ³¨æ„æ·±ãèª¿ã¹ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚',
        priority: 3,
        color: '#696969',
        interactive: false,
        sounds: ['debris_shift.mp3']
      }
    };
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.debugLog = function(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { message, type, timestamp };
      debugLogs.push(logEntry);
      
      console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      updateDebugPanel();
      
      if (debugLogs.length > 25) {
        debugLogs.shift();
      }
    }
    
    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
    window.selectObjectById = function(objectId) {
      const scene = document.querySelector('a-scene');
      const element = document.getElementById(objectId);
      
      if (element && scene.components['ar-interaction-handler']) {
        scene.components['ar-interaction-handler'].selectObject(element);
      }
    }
    
    window.highlightObject = function() {
      if (selectedObjectGlobal) {
        selectedObjectGlobal.classList.add('object-highlight');
        debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆ: ${selectedObjectGlobal.id}`, 'info');
        
        setTimeout(() => {
          selectedObjectGlobal.classList.remove('object-highlight');
        }, 3000);
      }
    }
    
    window.animateObject = function() {
      if (selectedObjectGlobal) {
        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
        const animations = [
          'property: rotation; to: 0 360 0; dur: 2000',
          'property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 1000; loop: 2',
          'property: position; to: ' + selectedObjectGlobal.getAttribute('position').x + ' ' + 
           (parseFloat(selectedObjectGlobal.getAttribute('position').y) + 0.5) + ' ' + 
           selectedObjectGlobal.getAttribute('position').z + '; dir: alternate; dur: 1500; loop: 2'
        ];
        
        const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
        selectedObjectGlobal.setAttribute('animation', randomAnimation);
        
        debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ: ${selectedObjectGlobal.id}`, 'info');
      }
    }
    
    window.deleteSelectedObject = function() {
      if (selectedObjectGlobal) {
        const objectId = selectedObjectGlobal.id;
        const index = placedModels.findIndex(model => model.id === objectId);
        
        if (index !== -1) {
          selectedObjectGlobal.remove();
          placedModels.splice(index, 1);
          
          // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰ã‚‚å‰Šé™¤
          const scene = document.querySelector('a-scene');
          if (scene.components['ar-interaction-handler']) {
            scene.components['ar-interaction-handler'].unregisterObject(objectId);
          }
          
          debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤: ${objectId}`, 'info');
          selectedObjectGlobal = null;
          
          // ã‚¿ãƒƒãƒæƒ…å ±ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
          document.getElementById('touch-info-panel').style.display = 'none';
          
          updateStatus('model-status', `é…ç½®æ¸ˆã¿: ${placedModels.length}`, true);
        }
      }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ›´æ–°
    function updateDebugPanel() {
      const logsContainer = document.getElementById('debug-logs');
      if (!logsContainer) return;
      
      logsContainer.innerHTML = debugLogs.slice(-8).map(log => {
        const className = `debug-log debug-${log.type}`;
        return `<div class="${className}">[${log.timestamp}] ${log.message}</div>`;
      }).join('');
      
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(id, text, isOk = true) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = text;
        element.className = `status-item ${isOk ? 'status-ok' : 'status-error'}`;
      }
    }
    
    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
    function initializePlatform() {
      let platformName = '';
      let arMethod = '';
      
      if (isIOS) {
        platformName = 'iOS';
        arMethod = 'AR Quick Look + model-viewer';
        currentPlatform = 'ios';
        
        // model-viewerã‚’è¡¨ç¤ºã€A-Frameã‚’éè¡¨ç¤º
        document.getElementById('model-viewer-container').style.display = 'block';
        document.getElementById('aframe-container').style.display = 'none';
        
        debugLog('iOSæ¤œå‡º: model-viewer ARãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'success');
        setupiOSAR();
        
      } else if (isAndroid) {
        platformName = 'Android';
        arMethod = 'WebXR + A-Frame';
        currentPlatform = 'android';
        
        // A-Frameã‚’è¡¨ç¤ºã€model-viewerã‚’éè¡¨ç¤º
        document.getElementById('aframe-container').style.display = 'block';
        document.getElementById('model-viewer-container').style.display = 'none';
        
        debugLog('Androidæ¤œå‡º: A-Frame WebXRãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'success');
        setupAndroidAR();
        
      } else {
        platformName = 'Desktop';
        arMethod = 'A-Frame VRãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰';
        currentPlatform = 'desktop';
        
        document.getElementById('aframe-container').style.display = 'block';
        document.getElementById('model-viewer-container').style.display = 'none';
        
        debugLog('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—æ¤œå‡º: A-Frame VRãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'info');
        setupDesktopMode();
      }
      
      // UIæ›´æ–°
      document.getElementById('platform-info').textContent = platformName;
      updateStatus('platform-status', `ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${platformName}`, true);
      
      const platformSpecificInfo = document.getElementById('platform-specific-info');
      platformSpecificInfo.innerHTML = `
        <p style="margin: 0; font-size: 12px; color: #ccc;">
          <strong>ARæ–¹å¼:</strong> ${arMethod}
        </p>
      `;
      
      debugLog(`ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†: ${platformName}`, 'success');
    }
    
    // iOS AR ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupiOSAR() {
      const viewer = document.getElementById('warehouse-viewer');
      const arButton = document.getElementById('ar-button');
      
      // model-viewer ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      viewer.addEventListener('load', () => {
        debugLog('å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† (model-viewer)', 'success');
        updateStatus('model-status', 'ãƒ¢ãƒ‡ãƒ«: èª­ã¿è¾¼ã¿å®Œäº†', true);
        document.getElementById('ar-status-text').textContent = 'ARæº–å‚™å®Œäº†';
      });
      
      viewer.addEventListener('ar-status', (event) => {
        if (event.detail.status === 'session-started') {
          debugLog('iOS ARã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
          document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
          const indicator = document.getElementById('ar-status-indicator');
          indicator.classList.add('active');
        }
      });
      
      // ARãƒœã‚¿ãƒ³ã®è¨­å®š
      arButton.style.background = 'linear-gradient(135deg, #00d4ff 0%, #0099cc 100%)';
      arButton.style.color = 'white';
      
      updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: model-viewer', true);
      
      // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
      document.getElementById('scale-controls').classList.add('show');
    }
    
    // Android AR ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupAndroidAR() {
      // WebXR ã‚µãƒãƒ¼ãƒˆç¢ºèª
      if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then(supported => {
          if (supported) {
            debugLog('WebXR AR ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª', 'success');
            updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: WebXR', true);
          } else {
            debugLog('WebXR AR éã‚µãƒãƒ¼ãƒˆã€AR.jsãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', 'warning');
            updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: AR.js', true);
          }
        }).catch(error => {
          debugLog(`WebXRç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¨ãƒ©ãƒ¼', false);
        });
      } else {
        debugLog('WebXR æœªå¯¾å¿œã€AR.jsã‚’ä½¿ç”¨', 'warning');
        updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: AR.js', true);
      }
    }
    
    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupDesktopMode() {
      debugLog('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰', 'info');
      updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰', true);
      
      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯å³åº§ã«é…ç½®å¯èƒ½
      setTimeout(() => {
        document.getElementById('place-warehouse-btn').disabled = false;
        document.getElementById('place-interactive-btn').disabled = false;
        document.getElementById('ar-status-text').textContent = 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - é…ç½®å¯èƒ½';
      }, 2000);
    }
    
    // ARé–‹å§‹
    function startAR() {
      if (currentPlatform === 'ios') {
        // iOS: model-viewerã®ARãƒœã‚¿ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
        const arButton = document.getElementById('ar-button');
        if (arButton) {
          arButton.click();
          debugLog('iOS ARé–‹å§‹', 'info');
        }
      } else {
        // Android/Desktop: A-Frame ARãƒ¢ãƒ¼ãƒ‰
        const scene = document.querySelector('a-scene');
        if (scene) {
          scene.enterVR();
          debugLog('A-Frame ARé–‹å§‹', 'info');
        }
      }
      
      document.getElementById('ar-btn-text').textContent = 'ARå®Ÿè¡Œä¸­';
    }
    
    // å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«é…ç½®
    function placeWarehouseModel() {
      if (currentPlatform === 'ios') {
        debugLog('iOS: model-viewerã§ç›´æ¥ARè¡¨ç¤º', 'info');
        return;
      }
      
      // Android/Desktop: A-Frameã§ãƒ¢ãƒ‡ãƒ«é…ç½®
      const scene = document.querySelector('a-scene');
      const hitTestComponent = scene.components['ar-hit-test'];
      
      let position = { x: 0, y: 0, z: -3 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®
      
      if (hitTestComponent && hitTestComponent.getCurrentPose()) {
        const pose = hitTestComponent.getCurrentPose();
        position = pose.transform.position;
        debugLog('Hit Teståº§æ¨™ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«é…ç½®', 'success');
      } else {
        debugLog('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ã§ãƒ¢ãƒ‡ãƒ«é…ç½®', 'info');
      }
      
      const warehouseData = objectTypes.warehouse;
      const modelId = `warehouse-${Date.now()}`;
      
      // å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
      const warehouseEntity = document.createElement('a-entity');
      
      // GLTFãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®š
      warehouseEntity.setAttribute('gltf-model', 'url(./models/abandoned_warehouse_-_interior_scene.glb)');
      warehouseEntity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
      warehouseEntity.setAttribute('scale', `${currentModelScale} ${currentModelScale} ${currentModelScale}`);
      warehouseEntity.setAttribute('rotation', '0 0 0');
      warehouseEntity.setAttribute('shadow', 'cast: true; receive: true');
      
      // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
      warehouseEntity.classList.add('interactive');
      warehouseEntity.setAttribute('data-priority', warehouseData.priority.toString());
      warehouseEntity.setAttribute('id', modelId);
      
      // ã‚†ã£ãã‚Šã¨ã—ãŸå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      warehouseEntity.setAttribute('animation', 
        'property: rotation; to: 0 360 0; loop: true; dur: 45000');
      
      // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ 
      document.getElementById('ar-world').appendChild(warehouseEntity);
      
      // é…ç½®ãƒªã‚¹ãƒˆã«è¿½åŠ 
      placedModels.push({
        id: modelId,
        name: warehouseData.name,
        type: 'warehouse',
        element: warehouseEntity,
        priority: warehouseData.priority
      });
      
      // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ç™»éŒ²
      const interactionHandler = scene.components['ar-interaction-handler'];
      if (interactionHandler) {
        interactionHandler.registerObject(warehouseEntity, {
          name: warehouseData.name,
          description: warehouseData.description,
          priority: warehouseData.priority,
          type: 'warehouse'
        });
      }
      
      debugLog(`${warehouseData.name}é…ç½®å®Œäº†: ${modelId}`, 'success');
      updateStatus('model-status', `é…ç½®æ¸ˆã¿: ${placedModels.length}`, true);
      showPlacementFeedback();
    }
    
    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®
    function placeInteractiveObject() {
      if (currentPlatform === 'ios') {
        debugLog('iOS: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯A-Frameç”¨æ©Ÿèƒ½ã§ã™', 'warning');
        return;
      }
      
      const scene = document.querySelector('a-scene');
      const hitTestComponent = scene.components['ar-hit-test'];
      
      let position = { x: Math.random() * 2 - 1, y: 0, z: -2 - Math.random() * 2 };
      
      if (hitTestComponent && hitTestComponent.getCurrentPose()) {
        const pose = hitTestComponent.getCurrentPose();
        position = {
          x: pose.transform.position.x + (Math.random() * 2 - 1),
          y: pose.transform.position.y,
          z: pose.transform.position.z + (Math.random() * 2 - 1)
        };
        debugLog('Hit Teståº§æ¨™å‘¨è¾ºã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®', 'info');
      }
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠï¼ˆå»ƒå€‰åº«ä»¥å¤–ï¼‰
      const availableTypes = Object.keys(objectTypes).filter(key => key !== 'warehouse');
      const selectedType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
      const objectData = objectTypes[selectedType];
      
      const objectId = `${selectedType}-${Date.now()}`;
      
      // åŸºæœ¬å½¢çŠ¶ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
      let objectEntity;
      switch (selectedType) {
        case 'machine':
          objectEntity = document.createElement('a-box');
          objectEntity.setAttribute('width', '0.8');
          objectEntity.setAttribute('height', '1.2');
          objectEntity.setAttribute('depth', '0.6');
          break;
        case 'generator':
          objectEntity = document.createElement('a-cylinder');
          objectEntity.setAttribute('radius', '0.5');
          objectEntity.setAttribute('height', '1.5');
          break;
        case 'container':
          objectEntity = document.createElement('a-box');
          objectEntity.setAttribute('width', '1.5');
          objectEntity.setAttribute('height', '1.0');
          objectEntity.setAttribute('depth', '0.8');
          break;
        case 'debris':
          objectEntity = document.createElement('a-dodecahedron');
          objectEntity.setAttribute('radius', '0.3');
          break;
        default:
          objectEntity = document.createElement('a-box');
      }
      
      // å…±é€šå±æ€§è¨­å®š
      objectEntity.setAttribute('position', `${position.x} ${position.y + 0.1} ${position.z}`);
      objectEntity.setAttribute('color', objectData.color);
      objectEntity.setAttribute('material', 'roughness: 0.8; metalness: 0.4');
      objectEntity.setAttribute('shadow', 'cast: true; receive: false');
      objectEntity.setAttribute('id', objectId);
      
      // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
      if (objectData.interactive) {
        objectEntity.classList.add('interactive');
        objectEntity.setAttribute('data-priority', objectData.priority.toString());
        
        // ãƒ›ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        objectEntity.setAttribute('animation__idle', 
          'property: rotation; to: 0 360 0; loop: true; dur: ' + (8000 + Math.random() * 4000));
      }
      
      // é…ç½®æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      objectEntity.setAttribute('animation__spawn', 
        'property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutBounce');
      
      // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ 
      document.getElementById('ar-world').appendChild(objectEntity);
      
      // é…ç½®ãƒªã‚¹ãƒˆã«è¿½åŠ 
      placedModels.push({
        id: objectId,
        name: objectData.name,
        type: selectedType,
        element: objectEntity,
        priority: objectData.priority
      });
      
      // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ç™»éŒ²
      if (objectData.interactive) {
        const interactionHandler = scene.components['ar-interaction-handler'];
        if (interactionHandler) {
          interactionHandler.registerObject(objectEntity, {
            name: objectData.name,
            description: objectData.description,
            priority: objectData.priority,
            type: selectedType
          });
        }
      }
      
      debugLog(`${objectData.name}é…ç½®å®Œäº†: ${objectId} (å„ªå…ˆåº¦: ${objectData.priority})`, 'success');
      updateStatus('model-status', `é…ç½®æ¸ˆã¿: ${placedModels.length}`, true);
      showPlacementFeedback();
    }
    
    // é…ç½®æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function showPlacementFeedback() {
      const instructions = document.getElementById('ar-instructions');
      const originalText = instructions.querySelector('#instruction-text').textContent;
      instructions.querySelector('#instruction-text').textContent = 'âœ… é…ç½®å®Œäº†ï¼';
      
      setTimeout(() => {
        instructions.querySelector('#instruction-text').textContent = originalText;
      }, 2000);
    }
    
    // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
    function changeScale(scale) {
      currentModelScale = scale;
      debugLog(`ãƒ¢ãƒ‡ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´: ${scale * 100}%`, 'info');
      
      if (currentPlatform === 'ios') {
        // model-viewerã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ãƒ­ã‚°ã®ã¿
        debugLog('iOS: ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã¯ARé…ç½®æ™‚ã«åæ˜ ã•ã‚Œã¾ã™', 'info');
      }
    }
    
    // å…¨ãƒ¢ãƒ‡ãƒ«å‰Šé™¤
    function clearModels() {
      placedModels.forEach(model => {
        if (model.element.parentNode) {
          model.element.remove();
        }
      });
      placedModels = [];
      debugLog('å…¨ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤', 'info');
      updateStatus('model-status', 'é…ç½®æ¸ˆã¿: 0', true);
    }
    
    // ã‚«ãƒ¡ãƒ©ç¢ºèª
    async function checkCamera() {
      try {
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªä¸­', 'info');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: OK', true);
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªæ¸ˆã¿', 'success');
        return true;
      } catch (error) {
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: ã‚¨ãƒ©ãƒ¼', false);
        debugLog(`ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return false;
      }
    }
    
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    function takeScreenshot() {
      if (currentPlatform === 'ios') {
        debugLog('iOS: model-viewerã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½åˆ¶é™', 'warning');
        return;
      }
      
      const scene = document.querySelector('a-scene');
      if (!scene || !scene.canvas) {
        debugLog('CanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      try {
        const canvas = scene.canvas;
        canvas.toBlob((blob) => {
          if (blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `warehouse-ar-${Date.now()}.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            debugLog('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜æˆåŠŸ', 'success');
          }
        });
      } catch (error) {
        debugLog(`ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (event) => {
      debugLog(`JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`, 'error');
    });
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('DOMèª­ã¿è¾¼ã¿å®Œäº†', 'success');
      
      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºãƒ»åˆæœŸåŒ–
      initializePlatform();
      
      // ã‚«ãƒ¡ãƒ©ç¢ºèª
      if (isMobile) {
        checkCamera();
      } else {
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—', true);
      }
      
      // A-Frameç¢ºèª
      if (window.AFRAME) {
        debugLog(`A-Frame ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${AFRAME.version}`, 'success');
      }
      
      setTimeout(() => {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('ar-status-text').textContent = 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šå®Œäº†';
      }, 2000);
    });
    
    // A-Frameã‚¤ãƒ™ãƒ³ãƒˆï¼ˆAndroid/Desktopç”¨ï¼‰
    if (!isIOS) {
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');
        
        if (scene) {
          scene.addEventListener('loaded', () => {
            debugLog('A-Frameã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†', 'success');
          });
          
          scene.addEventListener('enter-vr', () => {
            debugLog('A-Frame ARãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
            document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
            const indicator = document.getElementById('ar-status-indicator');
            indicator.classList.add('active');
          });
        }
      });
    }
    
    // ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®ï¼ˆA-Frameç”¨ï¼‰
    if (!isIOS) {
      document.addEventListener('click', (event) => {
        // UIãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if (event.target.closest('.btn') || event.target.closest('.debug-panel') || 
            event.target.closest('.info-panel') || event.target.closest('.model-scale-controls') ||
            event.target.closest('.object-manager') || event.target.closest('.touch-info-panel')) {
          return;
        }
        
        // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯é…ç½®ã—ãªã„
        const target = event.target;
        if (target.classList && target.classList.contains('interactive')) {
          return;
        }
        
        // é…ç½®ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿å®Ÿè¡Œ
        const warehouseBtn = document.getElementById('place-warehouse-btn');
        const interactiveBtn = document.getElementById('place-interactive-btn');
        
        if (!warehouseBtn.disabled || !interactiveBtn.disabled) {
          // ãƒ©ãƒ³ãƒ€ãƒ ã«ã©ã¡ã‚‰ã‹ã‚’é…ç½®ï¼ˆ50%ã®ç¢ºç‡ï¼‰
          if (Math.random() < 0.5 && !warehouseBtn.disabled) {
            placeWarehouseModel();
          } else if (!interactiveBtn.disabled) {
            placeInteractiveObject();
          }
        }
      });
      
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‡¦ç†
      document.addEventListener('touchend', (event) => {
        if (event.target.closest('.btn') || event.target.closest('.debug-panel') || 
            event.target.closest('.info-panel') || event.target.closest('.model-scale-controls') ||
            event.target.closest('.object-manager') || event.target.closest('.touch-info-panel')) {
          return;
        }
        
        event.preventDefault();
        
        // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ãƒƒãƒã®å ´åˆã¯é…ç½®ã—ãªã„
        const target = event.target;
        if (target.classList && target.classList.contains('interactive')) {
          return;
        }
        
        const warehouseBtn = document.getElementById('place-warehouse-btn');
        const interactiveBtn = document.getElementById('place-interactive-btn');
        
        if (!warehouseBtn.disabled || !interactiveBtn.disabled) {
          if (Math.random() < 0.5 && !warehouseBtn.disabled) {
            placeWarehouseModel();
          } else if (!interactiveBtn.disabled) {
            placeInteractiveObject();
          }
        }
      });
    }
    
    // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿½è·¡
    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      if (scene) {
        // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
        scene.addEventListener('object-selected', (event) => {
          selectedObjectGlobal = event.detail.element;
        });
      }
    });
  </script>
</body>
</html>