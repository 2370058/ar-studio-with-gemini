<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-Frame AR åºŠé¢èªè­˜ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      color: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 320px;
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #00d4ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-panel p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 8px;
      color: #e0e0e0;
    }
    
    .ar-status {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .ar-status.active {
      background: rgba(107, 207, 127, 0.2);
      border-color: rgba(107, 207, 127, 0.5);
    }
    
    .ar-status.error {
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.3);
    }
    
    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
    .debug-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 15px;
      border-radius: 12px;
      max-width: 400px;
      max-height: 60vh;
      overflow-y: auto;
      pointer-events: auto;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .debug-panel h3 {
      color: #ff6b6b;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .debug-log {
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #4ecdc4;
      font-size: 11px;
    }
    
    .debug-error {
      border-left-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }
    
    .debug-warning {
      border-left-color: #ffd93d;
      background: rgba(255, 217, 61, 0.1);
    }
    
    .debug-success {
      border-left-color: #6bcf7f;
      background: rgba(107, 207, 127, 0.1);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .status-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 11px;
    }
    
    .status-ok {
      background: rgba(107, 207, 127, 0.2);
    }
    
    .status-error {
      background: rgba(255, 107, 107, 0.2);
    }
    
    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      pointer-events: auto;
    }
    
    .btn {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      padding: 15px 25px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn.ar-active {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 6px 20px rgba(0,212,255,0.4); }
      50% { box-shadow: 0 6px 30px rgba(0,212,255,0.8); }
    }
    
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 2px solid rgba(0, 212, 255, 0.8);
      border-radius: 50%;
      pointer-events: none;
      z-index: 500;
      transition: all 0.3s;
    }
    
    .crosshair::before,
    .crosshair::after {
      content: '';
      position: absolute;
      background: rgba(0, 212, 255, 0.8);
    }
    
    .crosshair::before {
      width: 16px;
      height: 2px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .crosshair::after {
      width: 2px;
      height: 16px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .crosshair.ready {
      border-color: #6bcf7f;
      animation: ready-pulse 1s infinite;
    }
    
    .crosshair.ready::before,
    .crosshair.ready::after {
      background: #6bcf7f;
    }
    
    @keyframes ready-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }
    
    .placed-objects-list {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      pointer-events: auto;
      max-width: 300px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .placed-objects-list h4 {
      color: #00d4ff;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .object-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .delete-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
    }
    
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 15px;
      font-size: 18px;
      z-index: 2000;
      display: none;
      text-align: center;
    }
    
    .loading.show {
      display: block;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- A-Frameã‚·ãƒ¼ãƒ³ -->
  <a-scene 
    id="scene"
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    vr-mode-ui="enabled: false"
    background="color: transparent"
    ar-hit-test
  >
    <!-- ç’°å¢ƒå…‰ -->
    <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="0 5 5"></a-entity>
    
    <!-- ARç©ºé–“ï¼ˆé…ç½®ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
    <a-entity id="ar-world" position="0 0 0">
      <!-- é…ç½®ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </a-entity>
    
    <!-- ã‚«ãƒ¡ãƒ© -->
    <a-entity id="camera" camera look-controls wasd-controls="enabled: false" position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI -->
  <div class="overlay">
    <div class="info-panel">
      <h2>ğŸ¯ AR Floor Detection</h2>
      <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span id="ar-status-text">åˆæœŸåŒ–ä¸­...</span></p>
      <div id="ar-status-indicator" class="ar-status">
        <p style="margin: 0; font-size: 12px;">åºŠé¢ã‚’ã‚†ã£ãã‚Šã¨ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</p>
      </div>
      <p style="font-size: 12px; color: #999; margin-top: 10px;">
        åºŠé¢ã‚’æ¤œå‡ºå¾Œã€ã‚¿ãƒƒãƒ—ã§3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®
      </p>
    </div>
    
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel">
      <h3>ğŸ” AR Debug</h3>
      
      <div class="status-grid">
        <div class="status-item" id="webxr-status">WebXR: ç¢ºèªä¸­</div>
        <div class="status-item" id="camera-status">ã‚«ãƒ¡ãƒ©: æœªå–å¾—</div>
        <div class="status-item" id="plane-status">å¹³é¢æ¤œå‡º: å¾…æ©Ÿä¸­</div>
        <div class="status-item" id="objects-status">é…ç½®æ•°: 0</div>
      </div>
      
      <div id="debug-logs" style="max-height: 150px; overflow-y: auto;">
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
    </div>
    
    <!-- é…ç½®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
    <div class="placed-objects-list" id="objects-list" style="display: none;">
      <h4>ğŸ—ï¸ é…ç½®æ¸ˆã¿</h4>
      <div id="objects-container">
        <!-- é…ç½®ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤º -->
      </div>
    </div>
    
    <!-- ARã‚¯ãƒ­ã‚¹ãƒ˜ã‚¢ -->
    <div class="crosshair" id="crosshair" style="display: none;"></div>
    
    <div class="controls">
      <button class="btn primary" id="place-btn" onclick="placeObject()" disabled>
        <span>ğŸ“¦</span>
        <span>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®</span>
      </button>
      <button class="btn" onclick="clearAllObjects()">
        <span>ğŸ—‘ï¸</span>
        <span>å…¨å‰Šé™¤</span>
      </button>
      <button class="btn" onclick="takeScreenshot()">
        <span>ğŸ“¸</span>
        <span>ã‚¹ã‚¯ã‚·ãƒ§</span>
      </button>
    </div>
  </div>
  
  <div class="loading show" id="loading">
    <div class="loading-spinner"></div>
    <div>ARç’°å¢ƒã‚’åˆæœŸåŒ–ä¸­...</div>
  </div>

  <!-- AR Hit Test Component -->
  <script>
    AFRAME.registerComponent('ar-hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.hitTestResults = [];
        this.currentPose = null;
        this.isSessionActive = false;
        
        this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
        this.el.sceneEl.addEventListener('exit-vr', this.onExitVR.bind(this));
        
        this.debugLog('AR Hit Test ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–', 'info');
      },
      
      onEnterVR: function () {
        this.isSessionActive = true;
        const scene = this.el.sceneEl;
        const xrSession = scene.renderer.xr.getSession();
        
        if (xrSession) {
          this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
          this.setupHitTest(xrSession);
        }
      },
      
      onExitVR: function () {
        this.isSessionActive = false;
        this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†', 'info');
      },
      
      setupHitTest: async function (session) {
        try {
          this.viewerSpace = await session.requestReferenceSpace('viewer');
          const hitTestSource = await session.requestHitTestSource({
            space: this.viewerSpace
          });
          this.xrHitTestSource = hitTestSource;
          this.debugLog('Hit Test åˆæœŸåŒ–å®Œäº†', 'success');
          updateStatus('plane-status', 'å¹³é¢æ¤œå‡º: æº–å‚™å®Œäº†', true);
        } catch (error) {
          this.debugLog(`Hit Test ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateStatus('plane-status', 'å¹³é¢æ¤œå‡º: ã‚¨ãƒ©ãƒ¼', false);
        }
      },
      
      tick: function () {
        if (!this.isSessionActive || !this.xrHitTestSource) return;
        
        const frame = this.el.sceneEl.frame;
        if (!frame) return;
        
        const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
        
        if (hitTestResults.length > 0) {
          this.hitTestResults = hitTestResults;
          const hit = hitTestResults[0];
          const pose = hit.getPose(this.el.sceneEl.renderer.xr.getReferenceSpace());
          
          if (pose) {
            this.currentPose = pose;
            
            // ã‚¯ãƒ­ã‚¹ãƒ˜ã‚¢ã‚’è¡¨ç¤ºãƒ»æ›´æ–°
            const crosshair = document.getElementById('crosshair');
            crosshair.style.display = 'block';
            crosshair.classList.add('ready');
            
            // é…ç½®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const placeBtn = document.getElementById('place-btn');
            placeBtn.disabled = false;
            placeBtn.classList.add('ar-active');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('ar-status-text').textContent = 'åºŠé¢æ¤œå‡ºä¸­ - ã‚¿ãƒƒãƒ—ã§é…ç½®';
            const indicator = document.getElementById('ar-status-indicator');
            indicator.classList.add('active');
            
            updateStatus('plane-status', 'å¹³é¢æ¤œå‡º: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', true);
          }
        } else {
          // å¹³é¢ãŒæ¤œå‡ºã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹
          const crosshair = document.getElementById('crosshair');
          crosshair.classList.remove('ready');
          
          const placeBtn = document.getElementById('place-btn');
          placeBtn.disabled = true;
          placeBtn.classList.remove('ar-active');
          
          updateStatus('plane-status', 'å¹³é¢æ¤œå‡º: ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
        }
      },
      
      getCurrentPose: function () {
        return this.currentPose;
      },
      
      debugLog: function (message, type = 'info') {
        if (window.debugLog) {
          window.debugLog(message, type);
        }
      }
    });
  </script>

  <script>
    // ãƒ‡ãƒãƒƒã‚°è¨­å®š
    let debugMode = true;
    const debugLogs = [];
    let placedObjects = [];
    let objectCounter = 0;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.debugLog = function(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { message, type, timestamp };
      debugLogs.push(logEntry);
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      
      // ç”»é¢ã®ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã«è¡¨ç¤º
      updateDebugPanel();
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ä¸Šé™ç®¡ç†
      if (debugLogs.length > 30) {
        debugLogs.shift();
      }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ›´æ–°
    function updateDebugPanel() {
      const logsContainer = document.getElementById('debug-logs');
      if (!logsContainer) return;
      
      logsContainer.innerHTML = debugLogs.slice(-8).map(log => {
        const className = `debug-log debug-${log.type}`;
        return `<div class="${className}">[${log.timestamp}] ${log.message}</div>`;
      }).join('');
      
      // æœ€æ–°ãƒ­ã‚°ã‚’è¡¨ç¤º
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(id, text, isOk = true) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = text;
        element.className = `status-item ${isOk ? 'status-ok' : 'status-error'}`;
      }
    }
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®
    function placeObject() {
      const scene = document.querySelector('a-scene');
      const hitTestComponent = scene.components['ar-hit-test'];
      
      if (!hitTestComponent) {
        debugLog('Hit Test ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const pose = hitTestComponent.getCurrentPose();
      if (!pose) {
        debugLog('æœ‰åŠ¹ãªå¹³é¢ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        return;
      }
      
      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¨®é¡ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
      const objectTypes = [
        { type: 'box', color: '#ff6b6b', scale: '0.3 0.3 0.3', name: 'èµ¤ã„ç«‹æ–¹ä½“' },
        { type: 'sphere', color: '#4ecdc4', scale: '0.25 0.25 0.25', name: 'é’ã„çƒä½“' },
        { type: 'cylinder', color: '#45b7d1', scale: '0.2 0.4 0.2', name: 'é’ã„å††æŸ±' },
        { type: 'cone', color: '#96ceb4', scale: '0.25 0.5 0.25', name: 'ç·‘ã„å††éŒ' },
        { type: 'octahedron', color: '#ffd93d', scale: '0.3 0.3 0.3', name: 'é»„è‰²ã„å…«é¢ä½“' }
      ];
      
      const objectType = objectTypes[Math.floor(Math.random() * objectTypes.length)];
      objectCounter++;
      
      // 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      const entity = document.createElement(`a-${objectType.type}`);
      
      // ä½ç½®ã‚’è¨­å®šï¼ˆåºŠé¢ã«é…ç½®ï¼‰
      const position = pose.transform.position;
      entity.setAttribute('position', `${position.x} ${position.y + 0.1} ${position.z}`);
      
      // ãã®ä»–ã®å±æ€§
      entity.setAttribute('color', objectType.color);
      entity.setAttribute('scale', objectType.scale);
      entity.setAttribute('shadow', 'cast: true; receive: false');
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
      entity.setAttribute('animation', 
        'property: rotation; to: 0 360 0; loop: true; dur: 4000');
      entity.setAttribute('animation__hover', 
        'property: position; to: ' + position.x + ' ' + (position.y + 0.2) + ' ' + position.z + 
        '; dir: alternate; loop: true; dur: 2000');
      
      // IDã‚’è¨­å®š
      const objectId = `ar-object-${objectCounter}`;
      entity.setAttribute('id', objectId);
      
      // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ 
      document.getElementById('ar-world').appendChild(entity);
      
      // é…ç½®ãƒªã‚¹ãƒˆã«è¿½åŠ 
      placedObjects.push({
        id: objectId,
        name: objectType.name,
        element: entity
      });
      
      debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®: ${objectType.name} (${objectId})`, 'success');
      updateObjectsList();
      updateStatus('objects-status', `é…ç½®æ•°: ${placedObjects.length}`, true);
      
      // é…ç½®æˆåŠŸã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      showPlacementFeedback();
    }
    
    // é…ç½®æˆåŠŸã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function showPlacementFeedback() {
      const crosshair = document.getElementById('crosshair');
      crosshair.style.transform = 'translate(-50%, -50%) scale(1.5)';
      crosshair.style.borderColor = '#6bcf7f';
      
      setTimeout(() => {
        crosshair.style.transform = 'translate(-50%, -50%) scale(1)';
        crosshair.style.borderColor = 'rgba(0, 212, 255, 0.8)';
      }, 300);
    }
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§æ›´æ–°
    function updateObjectsList() {
      const container = document.getElementById('objects-container');
      const listPanel = document.getElementById('objects-list');
      
      if (placedObjects.length > 0) {
        listPanel.style.display = 'block';
        container.innerHTML = placedObjects.map(obj => `
          <div class="object-item">
            <span>${obj.name}</span>
            <button class="delete-btn" onclick="deleteObject('${obj.id}')">å‰Šé™¤</button>
          </div>
        `).join('');
      } else {
        listPanel.style.display = 'none';
      }
    }
    
    // å€‹åˆ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
    function deleteObject(objectId) {
      const index = placedObjects.findIndex(obj => obj.id === objectId);
      if (index !== -1) {
        const obj = placedObjects[index];
        if (obj.element.parentNode) {
          obj.element.remove();
        }
        placedObjects.splice(index, 1);
        debugLog(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤: ${obj.name}`, 'info');
        updateObjectsList();
        updateStatus('objects-status', `é…ç½®æ•°: ${placedObjects.length}`, true);
      }
    }
    
    // å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
    function clearAllObjects() {
      placedObjects.forEach(obj => {
        if (obj.element.parentNode) {
          obj.element.remove();
        }
      });
      placedObjects = [];
      debugLog('å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤', 'info');
      updateObjectsList();
      updateStatus('objects-status', 'é…ç½®æ•°: 0', true);
    }
    
    // ã‚«ãƒ¡ãƒ©ç¢ºèª
    async function checkCamera() {
      try {
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ', 'info');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: OK', true);
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');
        return true;
      } catch (error) {
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: ã‚¨ãƒ©ãƒ¼', false);
        debugLog(`ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return false;
      }
    }
    
    // WebXRç¢ºèª
    function checkWebXR() {
      if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then(supported => {
          if (supported) {
            updateStatus('webxr-status', 'WebXR: ARå¯¾å¿œ', true);
            debugLog('WebXR AR ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª', 'success');
          } else {
            updateStatus('webxr-status', 'WebXR: ARéå¯¾å¿œ', false);
            debugLog('WebXR AR éã‚µãƒãƒ¼ãƒˆ', 'warning');
          }
        }).catch(error => {
          updateStatus('webxr-status', 'WebXR: ã‚¨ãƒ©ãƒ¼', false);
          debugLog(`WebXRç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        });
      } else {
        updateStatus('webxr-status', 'WebXR: æœªå¯¾å¿œ', false);
        debugLog('WebXR æœªã‚µãƒãƒ¼ãƒˆ', 'warning');
      }
    }
    
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    function takeScreenshot() {
      const scene = document.querySelector('a-scene');
      if (!scene || !scene.canvas) {
        debugLog('CanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      try {
        const canvas = scene.canvas;
        canvas.toBlob((blob) => {
          if (blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `ar-screenshot-${Date.now()}.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            debugLog('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜æˆåŠŸ', 'success');
          } else {
            debugLog('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ç”Ÿæˆã«å¤±æ•—', 'error');
          }
        });
      } catch (error) {
        debugLog(`ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (event) => {
      debugLog(`JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`, 'error');
      console.error('Global error:', event.error);
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      debugLog(`Promise rejection: ${event.reason}`, 'error');
      console.error('Unhandled promise rejection:', event.reason);
    });
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('DOMèª­ã¿è¾¼ã¿å®Œäº†', 'success');
      
      checkCamera();
      checkWebXR();
      
      // A-Frameç¢ºèª
      if (window.AFRAME) {
        debugLog(`A-Frame ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${AFRAME.version}`, 'success');
      } else {
        debugLog('A-Frame ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      }
    });
    
    // A-Frameã‚·ãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      
      if (scene) {
        scene.addEventListener('loaded', () => {
          debugLog('A-Frameã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†', 'success');
          document.getElementById('loading').classList.remove('show');
          document.getElementById('ar-status-text').textContent = 'ARæº–å‚™å®Œäº†';
        });
        
        scene.addEventListener('renderstart', () => {
          debugLog('A-Frameãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹', 'info');
        });
        
        scene.addEventListener('enter-vr', () => {
          debugLog('ARãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
          document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
          const indicator = document.getElementById('ar-status-indicator');
          indicator.classList.add('active');
        });
        
        scene.addEventListener('exit-vr', () => {
          debugLog('ARãƒ¢ãƒ¼ãƒ‰çµ‚äº†', 'info');
          document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ çµ‚äº†';
          const indicator = document.getElementById('ar-status-indicator');
          indicator.classList.remove('active');
        });
      }
    });
    
    // ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®
    document.addEventListener('click', (event) => {
      // UIãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
      if (event.target.closest('.btn') || event.target.closest('.debug-panel') || event.target.closest('.info-panel')) {
        return;
      }
      
      const placeBtn = document.getElementById('place-btn');
      if (!placeBtn.disabled) {
        placeObject();
      }
    });
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‡¦ç†
    document.addEventListener('touchend', (event) => {
      if (event.target.closest('.btn') || event.target.closest('.debug-panel') || event.target.closest('.info-panel')) {
        return;
      }
      
      event.preventDefault();
      const placeBtn = document.getElementById('place-btn');
      if (!placeBtn.disabled) {
        placeObject();
      }
    });
  </script>
</body>
</html>