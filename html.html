<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ARèƒŒæ™¯åˆæˆã‚«ãƒ¡ãƒ©</title>
  
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>
  
  <style>
    /* === åŸºæœ¬è¨­å®š === */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-user-select: none;
      user-select: none; 
      -webkit-tap-highlight-color: transparent;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden; 
      background: #000; 
      height: 100vh; 
      width: 100vw; 
      color: white;
    }
    
    #container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* === å„ã‚¹ãƒ†ãƒƒãƒ—ã®ç”»é¢ === */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .screen.active {
      display: block;
      opacity: 1;
    }
    
    /* Step 1: èƒŒæ™¯èª¿æ•´ */
    #step1Screen { background: #111; }
    #backgroundCanvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      touch-action: none;
    }
    
    /* Step 2: ARæ’®å½± */
    #step2Screen { background: #1a1a1a; }
    model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: #1a1a1a;
      background-color: #1a1a1a;
    }
    
    /* Step 3: åˆæˆçµæœ */
    #step3Screen {
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #resultCanvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    /* === UIãƒ‘ãƒ¼ãƒ„ === */
    
    /* ä¸Šéƒ¨ã‚¬ã‚¤ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .top-info {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(20, 20, 20, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 14px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      line-height: 1.4;
      pointer-events: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    /* ä¸‹éƒ¨æ“ä½œã‚¨ãƒªã‚¢ */
    .bottom-controls {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      width: 90%;
      max-width: 400px;
    }
    
    /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .btn {
      border: none;
      padding: 16px 24px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn:active { transform: scale(0.96); }
    
    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³ï¼ˆå¼·èª¿ãƒ»æ±ºå®šï¼‰ */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    /* ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»æˆ»ã‚‹ï¼‰ */
    .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      width: 100%;
    }
    
    .btn-group .btn {
      flex: 1;
    }
    
    /* ARèµ·å‹•ãƒœã‚¿ãƒ³ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ */
    .ar-launch-btn {
      position: absolute !important;
      bottom: 180px !important; 
      left: 50% !important;
      transform: translateX(-50%) !important;
      background: white !important;
      color: #333 !important;
      border: none !important;
      padding: 12px 24px !important;
      border-radius: 30px !important;
      font-weight: 600 !important;
      font-size: 15px !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
      
      /* ä¿®æ­£: æœ€å‰é¢ã«é…ç½®ã—ã¦ã‚¿ãƒƒãƒ—å¯èƒ½ã«ã™ã‚‹ */
      z-index: 10000 !important;
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    .ar-launch-btn::before {
      content: "ğŸ“±";
      font-size: 18px;
    }
    
    /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .placeholder-message {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
      font-size: 15px;
      line-height: 1.8;
      width: 80%;
      pointer-events: none;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    #loading {
      position: absolute;
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 20, 0.9); 
      backdrop-filter: blur(10px);
      color: white;
      padding: 30px; 
      border-radius: 20px; 
      z-index: 2000;
      text-align: center;
      min-width: 200px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    .spinner {
      border: 3px solid rgba(255,255,255,0.2);
      border-top: 3px solid #764ba2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .loading-title { font-weight: bold; margin-bottom: 5px; }
    .progress-text { font-size: 12px; color: #aaa; }
    
    /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    @keyframes flash {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
    .flash {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: white; pointer-events: none; opacity: 0; z-index: 9999;
    }
    .flash.active { animation: flash 0.4s ease-out; }
  </style>
</head>
<body>

  <div id="container">
    <div id="step1Screen" class="screen active">
      <canvas id="backgroundCanvas"></canvas>
      
      <div class="top-info">
        <strong>Step 1: èƒŒæ™¯ã®èª¿æ•´</strong><br>
        ç”»é¢ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦èƒŒæ™¯ä½ç½®ã‚’èª¿æ•´ã—ã¾ã™
      </div>
      
      <div class="bottom-controls">
        <button class="btn btn-primary" onclick="goToStep2()">
          æ±ºå®šã—ã¦æ¬¡ã¸ â†’
        </button>
      </div>
    </div>
    
    <div id="step2Screen" class="screen">
      <div class="top-info">
        <strong>Step 2: ARæ’®å½± & åˆæˆ</strong><br>
        â‘  ARã§æ’®å½± â†’ â‘¡ ç”»åƒã‚’é¸æŠ
      </div>

      <div class="placeholder-message">
        <div style="font-size: 40px; margin-bottom: 10px; opacity: 0.5;">ğŸ‘¨â€ğŸš€</div>
        ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§<br>ARã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„
      </div>
      
      <model-viewer 
        id="viewer"
        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
        ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        shadow-intensity="1"
        auto-rotate>
        
        <button slot="ar-button" class="ar-launch-btn">
          ARã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
        </button>
      </model-viewer>
      
      <div class="bottom-controls">
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep1()">
            ğŸ”™ æˆ»ã‚‹
          </button>
          
          <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
          <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()">
            ğŸ–¼ï¸ ç”»åƒã‚’é¸æŠ
          </button>
        </div>
      </div>
    </div>
    
    <div id="step3Screen" class="screen">
      <canvas id="resultCanvas"></canvas>
      
      <div class="top-info" id="step3Info">
        <strong>âœ¨ å®Œæˆï¼</strong><br>
        åˆæˆãŒå®Œäº†ã—ã¾ã—ãŸ
      </div>
      
      <div class="bottom-controls">
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="resetAll()">
            ğŸ”„ æœ€åˆã‹ã‚‰
          </button>
          <button class="btn btn-primary" onclick="downloadResult()">
            ğŸ’¾ ä¿å­˜ã™ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <canvas id="tempCanvas" style="display:none;"></canvas>
  
  <div id="loading" style="display: none;">
    <div class="spinner"></div>
    <div class="loading-title" id="loadingText">å‡¦ç†ä¸­...</div>
    <div class="progress-text" id="progressText"></div>
  </div>
  
  <div class="flash" id="flash"></div>

  <script>
    // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ===
    let bgCanvas, bgCtx, resultCanvas, resultCtx, tempCanvas, tempCtx;
    let bodyPixNet = null;
    let currentStep = 1;
    
    // èƒŒæ™¯ç”»åƒè¨­å®š
    let bgImage = new Image();
    bgImage.crossOrigin = 'anonymous';
    bgImage.src = 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=2048';
    let bgOffsetX = 0;
    let finalBgImage = null;
    let arPhoto = null;
    
    // ã‚¿ãƒƒãƒæ“ä½œç”¨
    let lastX = 0;
    let isDragging = false;
    
    // === åˆæœŸåŒ– ===
    async function init() {
      // Canvasè¦ç´ å–å¾—
      bgCanvas = document.getElementById('backgroundCanvas');
      bgCtx = bgCanvas.getContext('2d');
      resultCanvas = document.getElementById('resultCanvas');
      resultCtx = resultCanvas.getContext('2d');
      tempCanvas = document.getElementById('tempCanvas');
      tempCtx = tempCanvas.getContext('2d');
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      setupTouchEvents();
      animateBackground();
      
      // BodyPixãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
      showLoading('æº–å‚™ä¸­...', 'AIãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™');
      try {
        bodyPixNet = await bodyPix.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          multiplier: 0.75,
          quantBytes: 2
        });
        hideLoading();
      } catch (error) {
        console.error(error);
        alert('AIãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        hideLoading();
      }
    }
    
    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      bgCanvas.width = w; bgCanvas.height = h;
      resultCanvas.width = w; resultCanvas.height = h;
    }
    
    // === èƒŒæ™¯æ“ä½œ (Step 1) ===
    function setupTouchEvents() {
      const startDrag = (x) => { lastX = x; isDragging = true; };
      const moveDrag = (x) => {
        if (!isDragging) return;
        const delta = x - lastX;
        bgOffsetX -= delta * 1.5; // ç§»å‹•é€Ÿåº¦èª¿æ•´
        lastX = x;
      };
      const endDrag = () => { isDragging = false; };

      // Touch
      bgCanvas.addEventListener('touchstart', e => { if(currentStep===1) startDrag(e.touches[0].clientX); }, {passive: true});
      bgCanvas.addEventListener('touchmove', e => { if(currentStep===1) moveDrag(e.touches[0].clientX); }, {passive: false});
      bgCanvas.addEventListener('touchend', endDrag);
      
      // Mouse
      bgCanvas.addEventListener('mousedown', e => { if(currentStep===1) startDrag(e.clientX); });
      bgCanvas.addEventListener('mousemove', e => { if(currentStep===1) moveDrag(e.clientX); });
      bgCanvas.addEventListener('mouseup', endDrag);
      bgCanvas.addEventListener('mouseleave', endDrag);
    }
    
    function animateBackground() {
      if (currentStep === 1) drawBackground();
      requestAnimationFrame(animateBackground);
    }
    
    function drawBackground() {
      if (!bgImage.complete) return;
      const w = bgCanvas.width;
      const h = bgCanvas.height;
      const scale = Math.max(w / bgImage.width, h / bgImage.height) * 1.2;
      const imgW = bgImage.width * scale;
      const imgH = bgImage.height * scale;
      
      let x = bgOffsetX % imgW;
      if (x > 0) x -= imgW;
      const y = (h - imgH) / 2;
      
      bgCtx.clearRect(0, 0, w, h);
      bgCtx.drawImage(bgImage, x, y, imgW, imgH);
      bgCtx.drawImage(bgImage, x + imgW, y, imgW, imgH);
      if (x + imgW < w) bgCtx.drawImage(bgImage, x + imgW * 2, y, imgW, imgH);
    }
    
    // === ç”»é¢é·ç§» ===
    function changeScreen(stepId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
    }

    function goToStep2() {
      finalBgImage = new Image();
      finalBgImage.src = bgCanvas.toDataURL();
      currentStep = 2;
      changeScreen('step2Screen');
    }
    
    function goToStep1() {
      currentStep = 1;
      changeScreen('step1Screen');
    }
    
    // === å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ & åˆæˆå‡¦ç† ===
    window.handlePhotoUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!bodyPixNet) { alert('AIæº–å‚™ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚'); return; }
      
      showLoading('ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...', '');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        arPhoto = new Image();
        arPhoto.onload = () => processComposite();
        arPhoto.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };
    
    async function processComposite() {
      showLoading('äººç‰©ã‚’åˆ‡ã‚ŠæŠœãä¸­...', 'AIè§£æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™');
      
      try {
        tempCanvas.width = arPhoto.width;
        tempCanvas.height = arPhoto.height;
        tempCtx.drawImage(arPhoto, 0, 0);
        
        const segmentation = await bodyPixNet.segmentPerson(tempCanvas, {
          flipHorizontal: false,
          internalResolution: 'medium',
          segmentationThreshold: 0.7
        });
        
        updateProgress('èƒŒæ™¯ã¨åˆæˆä¸­...');
        
        resultCanvas.width = arPhoto.width;
        resultCanvas.height = arPhoto.height;
        
        resultCtx.drawImage(finalBgImage, 0, 0, resultCanvas.width, resultCanvas.height);
        
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const resultData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
        const pixelCount = segmentation.data.length;
        
        for (let i = 0; i < pixelCount; i++) {
          if (segmentation.data[i] === 1) {
            const p = i * 4;
            resultData.data[p]     = imageData.data[p];
            resultData.data[p + 1] = imageData.data[p + 1];
            resultData.data[p + 2] = imageData.data[p + 2];
            resultData.data[p + 3] = 255;
          }
        }
        
        resultCtx.putImageData(resultData, 0, 0);
        
        currentStep = 3;
        changeScreen('step3Screen');
        hideLoading();
        
        const flash = document.getElementById('flash');
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 500);
        
      } catch (error) {
        console.error(error);
        alert('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        hideLoading();
      }
    }
    
    // === ä¿å­˜ & ãƒªã‚»ãƒƒãƒˆ ===
    window.downloadResult = function() {
      const link = document.createElement('a');
      link.download = `ar-composite-${Date.now()}.png`;
      link.href = resultCanvas.toDataURL('image/png');
      link.click();
      
      const info = document.getElementById('step3Info');
      const originalText = info.innerHTML;
      info.innerHTML = '<strong>ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸï¼</strong>';
      setTimeout(() => info.innerHTML = originalText, 2000);
    };
    
    window.resetAll = function() {
      currentStep = 1;
      bgOffsetX = 0;
      arPhoto = null;
      document.getElementById('photoInput').value = '';
      changeScreen('step1Screen');
    };
    
    // UIãƒ˜ãƒ«ãƒ‘ãƒ¼
    function showLoading(main, sub) {
      const el = document.getElementById('loading');
      el.style.display = 'block';
      document.getElementById('loadingText').textContent = main;
      document.getElementById('progressText').textContent = sub;
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    function updateProgress(text) {
      document.getElementById('progressText').textContent = text;
    }
    
    window.goToStep1 = goToStep1;
    window.goToStep2 = goToStep2;
    
    init();
  </script>
</body>
</html>