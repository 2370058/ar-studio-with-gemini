<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Platform AR - å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      background: #000;
    }
    
    .platform-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    
    /* A-Frameç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .aframe-container {
      width: 100%;
      height: 100%;
    }
    
    /* model-viewerç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .model-viewer-container {
      width: 100%;
      height: 100%;
      display: none;
    }
    
    model-viewer {
      width: 100%;
      height: 100%;
      background-color: transparent;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      color: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 320px;
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #00d4ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-panel p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 8px;
      color: #e0e0e0;
    }
    
    .platform-info {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .ar-status {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .ar-status.active {
      background: rgba(107, 207, 127, 0.2);
      border-color: rgba(107, 207, 127, 0.5);
    }
    
    .ar-status.error {
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.3);
    }
    
    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
    .debug-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 15px;
      border-radius: 12px;
      max-width: 380px;
      max-height: 60vh;
      overflow-y: auto;
      pointer-events: auto;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .debug-panel h3 {
      color: #ff6b6b;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .debug-log {
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #4ecdc4;
      font-size: 11px;
    }
    
    .debug-error {
      border-left-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }
    
    .debug-warning {
      border-left-color: #ffd93d;
      background: rgba(255, 217, 61, 0.1);
    }
    
    .debug-success {
      border-left-color: #6bcf7f;
      background: rgba(107, 207, 127, 0.1);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .status-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 11px;
    }
    
    .status-ok {
      background: rgba(107, 207, 127, 0.2);
    }
    
    .status-error {
      background: rgba(255, 107, 107, 0.2);
    }
    
    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      pointer-events: auto;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      padding: 15px 25px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn.ar-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: white;
    }
    
    .btn.ar-active {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 6px 20px rgba(0,212,255,0.4); }
      50% { box-shadow: 0 6px 30px rgba(0,212,255,0.8); }
    }
    
    .ar-instructions {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 14px;
      text-align: center;
      max-width: 300px;
      pointer-events: auto;
      display: none;
    }
    
    .ar-instructions.show {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px 40px;
      border-radius: 15px;
      font-size: 18px;
      z-index: 2000;
      display: none;
      text-align: center;
    }
    
    .loading.show {
      display: block;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* iOSå°‚ç”¨ã®AR Quick Lookç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .ios-ar-link {
      display: none;
    }

    .model-scale-controls {
      position: absolute;
      bottom: 150px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 12px;
      pointer-events: auto;
      display: none;
    }

    .model-scale-controls.show {
      display: block;
    }

    .scale-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .scale-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="platform-container">
    
    <!-- A-Frame AR (Android/Desktopç”¨) -->
    <div class="aframe-container" id="aframe-container">
      <a-scene 
        id="scene"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        background="color: transparent"
        ar-hit-test
      >
        <!-- ç’°å¢ƒå…‰ -->
        <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="0 5 5"></a-entity>
        
        <!-- ARç©ºé–“ï¼ˆé…ç½®ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
        <a-entity id="ar-world" position="0 0 0">
          <!-- é…ç½®ã•ã‚ŒãŸå»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </a-entity>
        
        <!-- ã‚«ãƒ¡ãƒ© -->
        <a-entity id="camera" camera look-controls wasd-controls="enabled: false" position="0 1.6 0"></a-entity>
      </a-scene>
    </div>

    <!-- model-viewer (iOSç”¨) -->
    <div class="model-viewer-container" id="model-viewer-container">
      <model-viewer
        id="warehouse-viewer"
        src="./models/abandoned_warehouse_-_interior_scene.glb"
        ar
        ar-modes="webxr scene-viewer quick-look"
        camera-controls
        shadow-intensity="1"
        auto-rotate
        auto-rotate-delay="3000"
        environment-image="neutral"
        poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23222'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='0.35em' fill='white' font-family='Arial' font-size='12'%3Eå»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«%3C/text%3E%3C/svg%3E"
      >
        <button id="ar-button" slot="ar-button" class="btn ar-btn">
          <span>ğŸ—ï¸</span>
          <span>ARã§é…ç½®</span>
        </button>
      </model-viewer>
    </div>

  </div>

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI -->
  <div class="overlay">
    <div class="info-panel">
      <h2>ğŸ—ï¸ å»ƒå€‰åº« ARé…ç½®</h2>
      <p><strong>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :</strong> <span id="platform-info">æ¤œå‡ºä¸­...</span></p>
      <div id="ar-status-indicator" class="ar-status">
        <p style="margin: 0; font-size: 12px;" id="ar-status-text">åˆæœŸåŒ–ä¸­...</p>
      </div>
      <div id="platform-specific-info" class="platform-info">
        <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®æƒ…å ±ãŒã“ã“ã«è¡¨ç¤º -->
      </div>
    </div>
    
    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel">
      <h3>ğŸ” ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨ºæ–­</h3>
      
      <div class="status-grid">
        <div class="status-item" id="platform-status">ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : æ¤œå‡ºä¸­</div>
        <div class="status-item" id="ar-support-status">ARã‚µãƒãƒ¼ãƒˆ: ç¢ºèªä¸­</div>
        <div class="status-item" id="camera-status">ã‚«ãƒ¡ãƒ©: æœªç¢ºèª</div>
        <div class="status-item" id="model-status">ãƒ¢ãƒ‡ãƒ«: èª­ã¿è¾¼ã¿ä¸­</div>
      </div>
      
      <div id="debug-logs" style="max-height: 150px; overflow-y: auto;">
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
    </div>
    
    <!-- ARä½¿ç”¨èª¬æ˜ -->
    <div class="ar-instructions" id="ar-instructions">
      <p id="instruction-text">åºŠé¢ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¿ãƒƒãƒ—ã§é…ç½®</p>
    </div>

    <!-- ãƒ¢ãƒ‡ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ -->
    <div class="model-scale-controls" id="scale-controls">
      <h4 style="color: white; margin-bottom: 10px; font-size: 12px;">ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º</h4>
      <button class="scale-btn" onclick="changeScale(0.5)">å° (50%)</button>
      <button class="scale-btn" onclick="changeScale(1.0)">æ¨™æº– (100%)</button>
      <button class="scale-btn" onclick="changeScale(2.0)">å¤§ (200%)</button>
    </div>
    
    <div class="controls">
      <button class="btn ar-btn" id="start-ar-btn" onclick="startAR()">
        <span>ğŸ“±</span>
        <span id="ar-btn-text">ARé–‹å§‹</span>
      </button>
      <button class="btn" id="place-model-btn" onclick="placeWarehouseModel()" disabled>
        <span>ğŸ—ï¸</span>
        <span>å»ƒå€‰åº«é…ç½®</span>
      </button>
      <button class="btn" onclick="clearModels()">
        <span>ğŸ—‘ï¸</span>
        <span>å‰Šé™¤</span>
      </button>
      <button class="btn primary" onclick="takeScreenshot()">
        <span>ğŸ“¸</span>
        <span>ã‚¹ã‚¯ã‚·ãƒ§</span>
      </button>
    </div>
  </div>
  
  <div class="loading show" id="loading">
    <div class="loading-spinner"></div>
    <div>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºä¸­...</div>
  </div>

  <!-- iOSç”¨AR Quick Look ãƒªãƒ³ã‚¯ (éè¡¨ç¤º) -->
  <a id="ios-ar-link" class="ios-ar-link" rel="ar" href="#">
    <img id="ios-ar-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" alt="AR View">
  </a>

  <!-- AR Hit Test Component for A-Frame -->
  <script>
    AFRAME.registerComponent('ar-hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.currentPose = null;
        this.isSessionActive = false;
        
        this.el.sceneEl.addEventListener('enter-vr', this.onEnterVR.bind(this));
        this.el.sceneEl.addEventListener('exit-vr', this.onExitVR.bind(this));
        
        this.debugLog('AR Hit Test ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–', 'info');
      },
      
      onEnterVR: function () {
        this.isSessionActive = true;
        const scene = this.el.sceneEl;
        const xrSession = scene.renderer.xr.getSession();
        
        if (xrSession) {
          this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
          this.setupHitTest(xrSession);
        }
      },
      
      onExitVR: function () {
        this.isSessionActive = false;
        this.debugLog('WebXR ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†', 'info');
      },
      
      setupHitTest: async function (session) {
        try {
          this.viewerSpace = await session.requestReferenceSpace('viewer');
          const hitTestSource = await session.requestHitTestSource({
            space: this.viewerSpace
          });
          this.xrHitTestSource = hitTestSource;
          this.debugLog('Hit Test åˆæœŸåŒ–å®Œäº†', 'success');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', true);
        } catch (error) {
          this.debugLog(`Hit Test ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¨ãƒ©ãƒ¼', false);
        }
      },
      
      tick: function () {
        if (!this.isSessionActive || !this.xrHitTestSource) return;
        
        const frame = this.el.sceneEl.frame;
        if (!frame) return;
        
        const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
        
        if (hitTestResults.length > 0) {
          this.hitTestResults = hitTestResults;
          const hit = hitTestResults[0];
          const pose = hit.getPose(this.el.sceneEl.renderer.xr.getReferenceSpace());
          
          if (pose) {
            this.currentPose = pose;
            
            // é…ç½®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const placeBtn = document.getElementById('place-model-btn');
            placeBtn.disabled = false;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('ar-status-text').textContent = 'åºŠé¢æ¤œå‡º - ã‚¿ãƒƒãƒ—ã§é…ç½®';
            const indicator = document.getElementById('ar-status-indicator');
            indicator.classList.add('active');
            
            // èª¬æ˜è¡¨ç¤º
            const instructions = document.getElementById('ar-instructions');
            instructions.classList.add('show');
          }
        } else {
          const placeBtn = document.getElementById('place-model-btn');
          placeBtn.disabled = true;
          
          const instructions = document.getElementById('ar-instructions');
          instructions.classList.remove('show');
        }
      },
      
      getCurrentPose: function () {
        return this.currentPose;
      },
      
      debugLog: function (message, type = 'info') {
        if (window.debugLog) {
          window.debugLog(message, type);
        }
      }
    });
  </script>

  <script>
    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡º
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;
    
    // ãƒ‡ãƒãƒƒã‚°è¨­å®š
    let debugMode = true;
    const debugLogs = [];
    let placedModels = [];
    let currentModelScale = 1.0;
    let currentPlatform = 'unknown';
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.debugLog = function(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { message, type, timestamp };
      debugLogs.push(logEntry);
      
      console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      updateDebugPanel();
      
      if (debugLogs.length > 25) {
        debugLogs.shift();
      }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ›´æ–°
    function updateDebugPanel() {
      const logsContainer = document.getElementById('debug-logs');
      if (!logsContainer) return;
      
      logsContainer.innerHTML = debugLogs.slice(-8).map(log => {
        const className = `debug-log debug-${log.type}`;
        return `<div class="${className}">[${log.timestamp}] ${log.message}</div>`;
      }).join('');
      
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(id, text, isOk = true) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = text;
        element.className = `status-item ${isOk ? 'status-ok' : 'status-error'}`;
      }
    }
    
    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
    function initializePlatform() {
      let platformName = '';
      let arMethod = '';
      
      if (isIOS) {
        platformName = 'iOS';
        arMethod = 'AR Quick Look + model-viewer';
        currentPlatform = 'ios';
        
        // model-viewerã‚’è¡¨ç¤ºã€A-Frameã‚’éè¡¨ç¤º
        document.getElementById('model-viewer-container').style.display = 'block';
        document.getElementById('aframe-container').style.display = 'none';
        
        debugLog('iOSæ¤œå‡º: model-viewer ARãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'success');
        setupiOSAR();
        
      } else if (isAndroid) {
        platformName = 'Android';
        arMethod = 'WebXR + A-Frame';
        currentPlatform = 'android';
        
        // A-Frameã‚’è¡¨ç¤ºã€model-viewerã‚’éè¡¨ç¤º
        document.getElementById('aframe-container').style.display = 'block';
        document.getElementById('model-viewer-container').style.display = 'none';
        
        debugLog('Androidæ¤œå‡º: A-Frame WebXRãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'success');
        setupAndroidAR();
        
      } else {
        platformName = 'Desktop';
        arMethod = 'A-Frame VRãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰';
        currentPlatform = 'desktop';
        
        document.getElementById('aframe-container').style.display = 'block';
        document.getElementById('model-viewer-container').style.display = 'none';
        
        debugLog('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—æ¤œå‡º: A-Frame VRãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨', 'info');
        setupDesktopMode();
      }
      
      // UIæ›´æ–°
      document.getElementById('platform-info').textContent = platformName;
      updateStatus('platform-status', `ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${platformName}`, true);
      
      const platformSpecificInfo = document.getElementById('platform-specific-info');
      platformSpecificInfo.innerHTML = `
        <p style="margin: 0; font-size: 12px; color: #ccc;">
          <strong>ARæ–¹å¼:</strong> ${arMethod}
        </p>
      `;
      
      debugLog(`ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†: ${platformName}`, 'success');
    }
    
    // iOS AR ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupiOSAR() {
      const viewer = document.getElementById('warehouse-viewer');
      const arButton = document.getElementById('ar-button');
      
      // model-viewer ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      viewer.addEventListener('load', () => {
        debugLog('å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† (model-viewer)', 'success');
        updateStatus('model-status', 'ãƒ¢ãƒ‡ãƒ«: èª­ã¿è¾¼ã¿å®Œäº†', true);
        document.getElementById('ar-status-text').textContent = 'ARæº–å‚™å®Œäº†';
      });
      
      viewer.addEventListener('ar-status', (event) => {
        if (event.detail.status === 'session-started') {
          debugLog('iOS ARã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
          document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
          const indicator = document.getElementById('ar-status-indicator');
          indicator.classList.add('active');
        }
      });
      
      // ARãƒœã‚¿ãƒ³ã®è¨­å®š
      arButton.style.background = 'linear-gradient(135deg, #00d4ff 0%, #0099cc 100%)';
      arButton.style.color = 'white';
      
      updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: model-viewer', true);
      
      // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
      document.getElementById('scale-controls').classList.add('show');
    }
    
    // Android AR ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupAndroidAR() {
      // WebXR ã‚µãƒãƒ¼ãƒˆç¢ºèª
      if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then(supported => {
          if (supported) {
            debugLog('WebXR AR ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª', 'success');
            updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: WebXR', true);
          } else {
            debugLog('WebXR AR éã‚µãƒãƒ¼ãƒˆã€AR.jsãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', 'warning');
            updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: AR.js', true);
          }
        }).catch(error => {
          debugLog(`WebXRç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ã‚¨ãƒ©ãƒ¼', false);
        });
      } else {
        debugLog('WebXR æœªå¯¾å¿œã€AR.jsã‚’ä½¿ç”¨', 'warning');
        updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: AR.js', true);
      }
    }
    
    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupDesktopMode() {
      debugLog('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰', 'info');
      updateStatus('ar-support-status', 'ARã‚µãƒãƒ¼ãƒˆ: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰', true);
      
      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯å³åº§ã«é…ç½®å¯èƒ½
      setTimeout(() => {
        document.getElementById('place-model-btn').disabled = false;
        document.getElementById('ar-status-text').textContent = 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - é…ç½®å¯èƒ½';
      }, 2000);
    }
    
    // ARé–‹å§‹
    function startAR() {
      if (currentPlatform === 'ios') {
        // iOS: model-viewerã®ARãƒœã‚¿ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
        const arButton = document.getElementById('ar-button');
        if (arButton) {
          arButton.click();
          debugLog('iOS ARé–‹å§‹', 'info');
        }
      } else {
        // Android/Desktop: A-Frame ARãƒ¢ãƒ¼ãƒ‰
        const scene = document.querySelector('a-scene');
        if (scene) {
          scene.enterVR();
          debugLog('A-Frame ARé–‹å§‹', 'info');
        }
      }
      
      document.getElementById('ar-btn-text').textContent = 'ARå®Ÿè¡Œä¸­';
    }
    
    // å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«é…ç½®
    function placeWarehouseModel() {
      if (currentPlatform === 'ios') {
        debugLog('iOS: model-viewerã§ç›´æ¥ARè¡¨ç¤º', 'info');
        return;
      }
      
      // Android/Desktop: A-Frameã§ãƒ¢ãƒ‡ãƒ«é…ç½®
      const scene = document.querySelector('a-scene');
      const hitTestComponent = scene.components['ar-hit-test'];
      
      let position = { x: 0, y: 0, z: -3 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®
      
      if (hitTestComponent && hitTestComponent.getCurrentPose()) {
        const pose = hitTestComponent.getCurrentPose();
        position = pose.transform.position;
        debugLog('Hit Teståº§æ¨™ã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«é…ç½®', 'success');
      } else {
        debugLog('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ã§ãƒ¢ãƒ‡ãƒ«é…ç½®', 'info');
      }
      
      // å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½œæˆ
      const warehouseEntity = document.createElement('a-entity');
      
      // GLTFãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®š
      warehouseEntity.setAttribute('gltf-model', 'url(./models/abandoned_warehouse_-_interior_scene.glb)');
      warehouseEntity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
      warehouseEntity.setAttribute('scale', `${currentModelScale} ${currentModelScale} ${currentModelScale}`);
      warehouseEntity.setAttribute('rotation', '0 0 0');
      warehouseEntity.setAttribute('shadow', 'cast: true; receive: true');
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
      warehouseEntity.setAttribute('animation', 
        'property: rotation; to: 0 360 0; loop: true; dur: 30000');
      
      // IDã‚’è¨­å®š
      const modelId = `warehouse-${Date.now()}`;
      warehouseEntity.setAttribute('id', modelId);
      
      // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ 
      document.getElementById('ar-world').appendChild(warehouseEntity);
      
      // é…ç½®ãƒªã‚¹ãƒˆã«è¿½åŠ 
      placedModels.push({
        id: modelId,
        name: `å»ƒå€‰åº« (${Math.round(currentModelScale * 100)}%)`,
        element: warehouseEntity
      });
      
      debugLog(`å»ƒå€‰åº«ãƒ¢ãƒ‡ãƒ«é…ç½®å®Œäº†: ${modelId}`, 'success');
      updateStatus('model-status', `é…ç½®æ¸ˆã¿: ${placedModels.length}`, true);
      
      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      showPlacementFeedback();
    }
    
    // é…ç½®æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function showPlacementFeedback() {
      const instructions = document.getElementById('ar-instructions');
      const originalText = instructions.querySelector('#instruction-text').textContent;
      instructions.querySelector('#instruction-text').textContent = 'âœ… é…ç½®å®Œäº†ï¼';
      
      setTimeout(() => {
        instructions.querySelector('#instruction-text').textContent = originalText;
      }, 2000);
    }
    
    // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
    function changeScale(scale) {
      currentModelScale = scale;
      debugLog(`ãƒ¢ãƒ‡ãƒ«ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´: ${scale * 100}%`, 'info');
      
      if (currentPlatform === 'ios') {
        // model-viewerã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ãƒ­ã‚°ã®ã¿
        debugLog('iOS: ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã¯ARé…ç½®æ™‚ã«åæ˜ ã•ã‚Œã¾ã™', 'info');
      }
    }
    
    // å…¨ãƒ¢ãƒ‡ãƒ«å‰Šé™¤
    function clearModels() {
      placedModels.forEach(model => {
        if (model.element.parentNode) {
          model.element.remove();
        }
      });
      placedModels = [];
      debugLog('å…¨ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤', 'info');
      updateStatus('model-status', 'é…ç½®æ¸ˆã¿: 0', true);
    }
    
    // ã‚«ãƒ¡ãƒ©ç¢ºèª
    async function checkCamera() {
      try {
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªä¸­', 'info');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: OK', true);
        debugLog('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªæ¸ˆã¿', 'success');
        return true;
      } catch (error) {
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: ã‚¨ãƒ©ãƒ¼', false);
        debugLog(`ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return false;
      }
    }
    
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    function takeScreenshot() {
      if (currentPlatform === 'ios') {
        debugLog('iOS: model-viewerã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½åˆ¶é™', 'warning');
        return;
      }
      
      const scene = document.querySelector('a-scene');
      if (!scene || !scene.canvas) {
        debugLog('CanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      try {
        const canvas = scene.canvas;
        canvas.toBlob((blob) => {
          if (blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `warehouse-ar-${Date.now()}.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            debugLog('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜æˆåŠŸ', 'success');
          }
        });
      } catch (error) {
        debugLog(`ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (event) => {
      debugLog(`JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`, 'error');
    });
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('DOMèª­ã¿è¾¼ã¿å®Œäº†', 'success');
      
      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œå‡ºãƒ»åˆæœŸåŒ–
      initializePlatform();
      
      // ã‚«ãƒ¡ãƒ©ç¢ºèª
      if (isMobile) {
        checkCamera();
      } else {
        updateStatus('camera-status', 'ã‚«ãƒ¡ãƒ©: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—', true);
      }
      
      // A-Frameç¢ºèª
      if (window.AFRAME) {
        debugLog(`A-Frame ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${AFRAME.version}`, 'success');
      }
      
      setTimeout(() => {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('ar-status-text').textContent = 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šå®Œäº†';
      }, 2000);
    });
    
    // A-Frameã‚¤ãƒ™ãƒ³ãƒˆï¼ˆAndroid/Desktopç”¨ï¼‰
    if (!isIOS) {
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');
        
        if (scene) {
          scene.addEventListener('loaded', () => {
            debugLog('A-Frameã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿å®Œäº†', 'success');
          });
          
          scene.addEventListener('enter-vr', () => {
            debugLog('A-Frame ARãƒ¢ãƒ¼ãƒ‰é–‹å§‹', 'success');
            document.getElementById('ar-status-text').textContent = 'ARãƒ¢ãƒ¼ãƒ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–';
            const indicator = document.getElementById('ar-status-indicator');
            indicator.classList.add('active');
          });
        }
      });
    }
    
    // ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ‡ãƒ«é…ç½®ï¼ˆA-Frameç”¨ï¼‰
    if (!isIOS) {
      document.addEventListener('click', (event) => {
        if (event.target.closest('.btn') || event.target.closest('.debug-panel') || 
            event.target.closest('.info-panel') || event.target.closest('.model-scale-controls')) {
          return;
        }
        
        const placeBtn = document.getElementById('place-model-btn');
        if (!placeBtn.disabled) {
          placeWarehouseModel();
        }
      });
    }
  </script>
</body>
</html>