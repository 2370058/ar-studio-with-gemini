<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ARèƒŒæ™¯åˆæˆã‚«ãƒ¡ãƒ©</title>
  
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-user-select: none;
      user-select: none; 
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden; 
      background: #000; 
      height: 100vh; 
      width: 100vw; 
    }
    
    #container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* === å„ã‚¹ãƒ†ãƒƒãƒ—ã®ç”»é¢ === */
    
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }
    
    .screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    /* Step 1: èƒŒæ™¯èª¿æ•´ç”»é¢ */
    #step1Screen {
      background: #000;
    }
    
    #backgroundCanvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      touch-action: none;
    }
    
    /* Step 2: ARæ’®å½±ç”»é¢ */
    #step2Screen model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
    }
    
    /* Step 3: åˆæˆçµæœç”»é¢ */
    #step3Screen {
      background: #000;
    }
    
    #resultCanvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* === UIè¦ç´  === */
    
    .ui-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .info-box {
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      font-size: 14px;
      text-align: center;
      max-width: 90%;
      line-height: 1.5;
    }
    
    .btn {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      padding: 14px 32px;
      border-radius: 30px;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:active { 
      transform: scale(0.95); 
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
    }
    
    #loading {
      position: absolute;
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95); 
      color: white;
      padding: 30px 40px; 
      border-radius: 15px; 
      z-index: 2000;
      text-align: center;
    }
    
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .progress-text {
      margin-top: 10px;
      font-size: 14px;
      color: #aaa;
    }
    
    /* æ’®å½±ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    @keyframes flash {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    .flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      pointer-events: none;
      opacity: 0;
      z-index: 9999;
    }
    
    .flash.active {
      animation: flash 0.3s ease-out;
    }
  </style>
</head>
<body>

  <div id="container">
    <!-- Step 1: èƒŒæ™¯èª¿æ•´ -->
    <div id="step1Screen" class="screen active">
      <canvas id="backgroundCanvas"></canvas>
      
      <div class="ui-overlay">
        <div class="info-box">
          <strong>ğŸ“ Step 1: èƒŒæ™¯èª¿æ•´</strong><br>
          ç”»é¢ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å¥½ããªè§’åº¦ã«èª¿æ•´ã—ã¦ãã ã•ã„
        </div>
        <button class="btn" id="step1NextBtn" onclick="goToStep2()">
          âœ… èƒŒæ™¯ç¢ºå®š â†’ ARæ’®å½±ã¸
        </button>
      </div>
    </div>
    
    <!-- Step 2: ARæ’®å½± -->
    <div id="step2Screen" class="screen">
      <model-viewer 
        id="viewer"
        src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
        ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        shadow-intensity="1"
        auto-rotate>
        
        <button slot="ar-button" style="
          position: absolute;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: white;
          border: none;
          padding: 16px 40px;
          border-radius: 30px;
          font-weight: 700;
          font-size: 18px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          cursor: pointer;
        ">
          ğŸ“± ARã§æ’®å½±ã™ã‚‹
        </button>
      </model-viewer>
      
      <div class="ui-overlay">
        <div class="info-box">
          <strong>ğŸ“¸ Step 2: ARæ’®å½±</strong><br>
          ã€ŒARã§æ’®å½±ã™ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ãƒ‡ãƒã‚¤ã‚¹ã®ARãƒ¢ãƒ¼ãƒ‰ã§æ’®å½±ã—ã¦ãã ã•ã„<br>
          <span style="font-size: 12px; color: #aaa;">
            æ’®å½±å¾Œã€å†™çœŸã‚¢ãƒ—ãƒªã‹ã‚‰ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„
          </span>
        </div>
        <div class="btn-group">
          <button class="btn" onclick="goToStep1()">ğŸ”™ èƒŒæ™¯èª¿æ•´ã«æˆ»ã‚‹</button>
          <input 
            type="file" 
            id="photoInput" 
            accept="image/*" 
            style="display: none;"
            onchange="handlePhotoUpload(event)">
          <button class="btn" onclick="document.getElementById('photoInput').click()">
            ğŸ–¼ï¸ æ’®å½±ã—ãŸå†™çœŸã‚’é¸æŠ
          </button>
        </div>
      </div>
    </div>
    
    <!-- Step 3: åˆæˆçµæœ -->
    <div id="step3Screen" class="screen">
      <canvas id="resultCanvas"></canvas>
      
      <div class="ui-overlay">
        <div class="info-box" id="step3Info">
          <strong>âœ¨ Step 3: å®Œæˆï¼</strong><br>
          èƒŒæ™¯ãŒåˆæˆã•ã‚Œã¾ã—ãŸ
        </div>
        <div class="btn-group">
          <button class="btn" onclick="downloadResult()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn" onclick="resetAll()">ğŸ”„ æœ€åˆã‹ã‚‰</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- éè¡¨ç¤ºè¦ç´  -->
  <canvas id="tempCanvas" style="display:none;"></canvas>
  
  <div id="loading" style="display: none;">
    <div class="spinner"></div>
    <div id="loadingText">å‡¦ç†ä¸­...</div>
    <div class="progress-text" id="progressText"></div>
  </div>
  
  <div class="flash" id="flash"></div>

  <script>
    // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ===
    let bgCanvas, bgCtx, resultCanvas, resultCtx, tempCanvas, tempCtx;
    let bodyPixNet = null;
    let currentStep = 1;
    
    // èƒŒæ™¯ç”»åƒ
    let bgImage = new Image();
    bgImage.crossOrigin = 'anonymous';
    bgImage.src = 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=2048';
    let bgOffsetX = 0;
    let finalBgImage = null; // ç¢ºå®šã—ãŸèƒŒæ™¯
    
    // ARæ’®å½±ç”»åƒ
    let arPhoto = null;
    
    // ã‚¿ãƒƒãƒæ“ä½œ
    let lastX = 0;
    let isDragging = false;
    
    // === åˆæœŸåŒ– ===
    async function init() {
      // Canvasè¦ç´ å–å¾—
      bgCanvas = document.getElementById('backgroundCanvas');
      bgCtx = bgCanvas.getContext('2d');
      resultCanvas = document.getElementById('resultCanvas');
      resultCtx = resultCanvas.getContext('2d');
      tempCanvas = document.getElementById('tempCanvas');
      tempCtx = tempCanvas.getContext('2d');
      
      // Canvasã‚µã‚¤ã‚ºè¨­å®š
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      setupTouchEvents();
      
      // èƒŒæ™¯æç”»é–‹å§‹
      animateBackground();
      
      // BodyPixèª­ã¿è¾¼ã¿ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ï¼‰
      showLoading('AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'ã“ã‚Œã«ã¯20-30ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™');
      
      try {
        bodyPixNet = await bodyPix.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          multiplier: 0.75,
          quantBytes: 2
        });
        
        console.log('BodyPix loaded');
        hideLoading();
        
      } catch (error) {
        console.error('BodyPix error:', error);
        alert('AIãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        hideLoading();
      }
    }
    
    function resizeCanvas() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      
      bgCanvas.width = width;
      bgCanvas.height = height;
      resultCanvas.width = width;
      resultCanvas.height = height;
    }
    
    // === ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ ===
    function setupTouchEvents() {
      bgCanvas.addEventListener('touchstart', e => {
        if (currentStep === 1) {
          e.preventDefault();
          lastX = e.touches[0].clientX;
          isDragging = true;
        }
      }, { passive: false });
      
      bgCanvas.addEventListener('touchmove', e => {
        if (currentStep === 1 && isDragging) {
          e.preventDefault();
          const deltaX = e.touches[0].clientX - lastX;
          bgOffsetX -= deltaX * 2;
          lastX = e.touches[0].clientX;
        }
      }, { passive: false });
      
      bgCanvas.addEventListener('touchend', () => {
        isDragging = false;
      });
      
      // ãƒã‚¦ã‚¹å¯¾å¿œ
      bgCanvas.addEventListener('mousedown', e => {
        if (currentStep === 1) {
          lastX = e.clientX;
          isDragging = true;
        }
      });
      
      bgCanvas.addEventListener('mousemove', e => {
        if (currentStep === 1 && isDragging) {
          const deltaX = e.clientX - lastX;
          bgOffsetX -= deltaX * 2;
          lastX = e.clientX;
        }
      });
      
      bgCanvas.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }
    
    // === èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===
    function animateBackground() {
      if (currentStep === 1) {
        drawBackground();
      }
      requestAnimationFrame(animateBackground);
    }
    
    function drawBackground() {
      if (!bgImage.complete) return;
      
      const w = bgCanvas.width;
      const h = bgCanvas.height;
      const scale = Math.max(w / bgImage.width, h / bgImage.height) * 1.5;
      const imgW = bgImage.width * scale;
      const imgH = bgImage.height * scale;
      
      let x = bgOffsetX % imgW;
      if (x > 0) x -= imgW;
      const y = (h - imgH) / 2;
      
      bgCtx.clearRect(0, 0, w, h);
      bgCtx.drawImage(bgImage, x, y, imgW, imgH);
      bgCtx.drawImage(bgImage, x + imgW, y, imgW, imgH);
      
      if (x + imgW < w) {
        bgCtx.drawImage(bgImage, x + imgW * 2, y, imgW, imgH);
      }
    }
    
    // === Stepé·ç§» ===
    function goToStep2() {
      // èƒŒæ™¯ã‚’ç¢ºå®šï¼ˆç”»åƒã¨ã—ã¦ä¿å­˜ï¼‰
      finalBgImage = new Image();
      finalBgImage.src = bgCanvas.toDataURL();
      
      currentStep = 2;
      document.getElementById('step1Screen').classList.remove('active');
      document.getElementById('step2Screen').classList.add('active');
    }
    
    function goToStep1() {
      currentStep = 1;
      document.getElementById('step2Screen').classList.remove('active');
      document.getElementById('step1Screen').classList.add('active');
    }
    
    // === å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===
    window.handlePhotoUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!bodyPixNet) {
        alert('AIãƒ¢ãƒ‡ãƒ«ãŒã¾ã èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
      }
      
      showLoading('ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...', '');
      
      // ç”»åƒèª­ã¿è¾¼ã¿
      const reader = new FileReader();
      reader.onload = async (e) => {
        arPhoto = new Image();
        arPhoto.onload = async () => {
          await processComposite();
        };
        arPhoto.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };
    
    // === åˆæˆå‡¦ç† ===
    async function processComposite() {
      showLoading('äººç‰©ã‚’æ¤œå‡ºä¸­...', 'ã“ã®å‡¦ç†ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™');
      
      try {
        // ä½œæ¥­ç”¨Canvasã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
        tempCanvas.width = arPhoto.width;
        tempCanvas.height = arPhoto.height;
        
        // ARå†™çœŸã‚’æç”»
        tempCtx.drawImage(arPhoto, 0, 0);
        
        updateProgress('äººç‰©æ¤œå‡ºä¸­... (1/3)');
        
        // äººç‰©ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé™æ­¢ç”»ãªã®ã§1å›ã ã‘ï¼‰
        const segmentation = await bodyPixNet.segmentPerson(tempCanvas, {
          flipHorizontal: false,
          internalResolution: 'medium',
          segmentationThreshold: 0.7
        });
        
        updateProgress('èƒŒæ™¯åˆæˆä¸­... (2/3)');
        
        // çµæœCanvasæº–å‚™
        resultCanvas.width = arPhoto.width;
        resultCanvas.height = arPhoto.height;
        
        // 1. èƒŒæ™¯ã‚’æç”»
        resultCtx.drawImage(finalBgImage, 0, 0, resultCanvas.width, resultCanvas.height);
        
        updateProgress('ä»•ä¸Šã’ä¸­... (3/3)');
        
        // 2. ARå†™çœŸã‹ã‚‰äººç‰©éƒ¨åˆ†ã®ã¿æŠ½å‡ºã—ã¦åˆæˆ
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const resultData = resultCtx.createImageData(resultCanvas.width, resultCanvas.height);
        
        // èƒŒæ™¯ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const bgData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
        
        // åˆæˆ
        for (let i = 0; i < segmentation.data.length; i++) {
          const p = i * 4;
          
          if (segmentation.data[i] === 1) {
            // äººç‰©éƒ¨åˆ†: ARå†™çœŸã®è‰²ã‚’ä½¿ç”¨
            resultData.data[p]     = imageData.data[p];
            resultData.data[p + 1] = imageData.data[p + 1];
            resultData.data[p + 2] = imageData.data[p + 2];
            resultData.data[p + 3] = 255;
          } else {
            // èƒŒæ™¯éƒ¨åˆ†: èª¿æ•´æ¸ˆã¿èƒŒæ™¯ã‚’ä½¿ç”¨
            resultData.data[p]     = bgData.data[p];
            resultData.data[p + 1] = bgData.data[p + 1];
            resultData.data[p + 2] = bgData.data[p + 2];
            resultData.data[p + 3] = 255;
          }
        }
        
        resultCtx.putImageData(resultData, 0, 0);
        
        // Step 3ã¸
        currentStep = 3;
        document.getElementById('step2Screen').classList.remove('active');
        document.getElementById('step3Screen').classList.add('active');
        
        hideLoading();
        
        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        const flash = document.getElementById('flash');
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 300);
        
      } catch (error) {
        console.error('Composite error:', error);
        alert('åˆæˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        hideLoading();
      }
    }
    
    // === ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ===
    window.downloadResult = function() {
      const dataUrl = resultCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = `ar-composite-${Date.now()}.png`;
      link.href = dataUrl;
      link.click();
      
      document.getElementById('step3Info').innerHTML = 
        '<strong>ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸï¼</strong><br>å†™çœŸã‚¢ãƒ—ãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      
      setTimeout(() => {
        document.getElementById('step3Info').innerHTML = 
          '<strong>âœ¨ Step 3: å®Œæˆï¼</strong><br>èƒŒæ™¯ãŒåˆæˆã•ã‚Œã¾ã—ãŸ';
      }, 2000);
    };
    
    // === ãƒªã‚»ãƒƒãƒˆ ===
    window.resetAll = function() {
      currentStep = 1;
      bgOffsetX = 0;
      arPhoto = null;
      finalBgImage = null;
      
      document.getElementById('step3Screen').classList.remove('active');
      document.getElementById('step1Screen').classList.add('active');
      document.getElementById('photoInput').value = '';
    };
    
    // === UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===
    function showLoading(text, subtext) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loadingText').textContent = text;
      document.getElementById('progressText').textContent = subtext;
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    function updateProgress(text) {
      document.getElementById('progressText').textContent = text;
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
    window.goToStep1 = goToStep1;
    window.goToStep2 = goToStep2;
    
    // === èµ·å‹• ===
    init();
  </script>
</body>
</html>